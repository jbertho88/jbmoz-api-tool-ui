<!DOCTYPE html>
<html lang="en"> <!-- Theme class will be added here by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Advanced Moz API Tool for SEO data analysis and link building research">
    <title>Advanced Moz API Tool</title>
    
    <!-- Preload critical resources for faster loading -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    
    <!-- DNS prefetch for additional performance -->
    <link rel="dns-prefetch" href="https://upload.wikimedia.org">
    <link rel="dns-prefetch" href="https://mozapi-proxy-server.vercel.app">
    
    <!-- Load Tailwind CSS synchronously to prevent FOUC -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load fonts with immediate fallback -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    
    <!-- Tabulator CSS - Load synchronously to prevent FOUC -->
    <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">
    <link rel="preload" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"></noscript>
    
    <!-- Load Tabulator JS asynchronously with error handling -->
    <script>
        // Load Tabulator asynchronously to improve initial page load
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.onerror = function() {
                console.warn('Failed to load Tabulator library. Table functionality will be limited.');
            };
            document.head.appendChild(script);
        })();
    </script>
    <style>
        /* Critical CSS - Prevents FOUC */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        /* Loading state - hidden until CSS loads */
        .css-loading {
            opacity: 0;
        }
        
        .css-loaded {
            opacity: 1;
        }
        
        /* Base styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            padding: 0;
            will-change: background-color, color;
        }

        /* Theme Variables - Light (Default) */
        :root, .light {
            /* Backgrounds */
            --bg-body: #f9fafb;
            --bg-container: #ffffff;
            --bg-container-translucent: rgba(255, 255, 255, 0.5);
            --bg-input: #f3f4f6;
            --bg-input-secondary: #e5e7eb;
            --bg-code: #fefce8;
            --bg-disabled: #d1d5db;
            
            /* Borders */
            --border-primary: #e5e7eb;
            --border-secondary: #d1d5db;
            
            /* Text Colors */
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-accent: #0284c7;
            --text-accent-hover: #0369a1;
            --text-heading: #0ea5e9;
            --text-error: #b91c1c;
            
            /* Button Colors */
            --btn-primary-bg: #002F50;
            --btn-primary-hover: #001d30;
            --btn-copy-bg: #f97316;
            --btn-copy-hover: #ea580c;
            --btn-export-bg: #10b981;
            --btn-export-hover: #059669;
            --btn-view-data-bg: #0ea5e9;
            --btn-view-data-hover: #0284c7;
            
            /* Error Colors */
            --error-bg: #fee2e2;
            --error-border: #fca5a5;
            
            /* Tabulator Colors */
            --tabulator-header-bg: var(--bg-input);
            --tabulator-row-bg: var(--bg-container);
            --tabulator-row-even-bg: var(--bg-input-secondary);
            --tabulator-border: var(--border-primary);
            --tabulator-text: var(--text-primary);
            --tabulator-footer-bg: var(--bg-input);
            --tabulator-pag-button-bg: var(--bg-container);
            --tabulator-pag-button-hover: var(--bg-input-secondary);
        }

        /* Dark Theme */
        .dark {
            --bg-body: #020617;
            --bg-container: #1e293b;
            --bg-container-translucent: rgba(30, 41, 59, 0.5);
            --bg-input: #0f172a;
            --bg-input-secondary: #334155;
            --bg-code: #000000;
            --bg-disabled: #475569;
            --border-primary: #334155;
            --border-secondary: #475569;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-accent: #38bdf8;
            --text-accent-hover: #7dd3fc;
            --text-heading: #38bdf8;
            --text-error: #f87171;
            --btn-primary-bg: #0ea5e9;
            --btn-primary-hover: #38bdf8;
            --btn-copy-bg: #f97316;
            --btn-copy-hover: #fb923c;
            --btn-export-bg: #10b981;
            --btn-export-hover: #34d399;
            --btn-view-data-bg: #0ea5e9;
            --btn-view-data-hover: #38bdf8;
            --error-bg: rgba(153, 27, 27, 0.5);
            --error-border: #ef4444;
            --tabulator-header-bg: var(--bg-input);
            --tabulator-row-bg: #1e293b;
            --tabulator-row-even-bg: #0f172a;
            --tabulator-border: var(--border-primary);
            --tabulator-text: var(--text-primary);
            --tabulator-footer-bg: var(--bg-input);
            --tabulator-pag-button-bg: var(--bg-input-secondary);
            --tabulator-pag-button-hover: #475569;
        }

        /* Retro Theme */
        .retro {
            --bg-body: #000000;
            --bg-container: #1a001a;
            --bg-container-translucent: rgba(26, 0, 26, 0.5);
            --bg-input: #2a002a;
            --bg-input-secondary: #3d003d;
            --bg-code: #000000;
            --bg-disabled: #4a148c;
            --border-primary: #4a148c;
            --border-secondary: #6a1b9a;
            --text-primary: #e0e0e0;
            --text-secondary: #ad5eda;
            --text-accent: #2de2e6;
            --text-accent-hover: #81f7f9;
            --text-heading: #9700cc;
            --text-error: #f6019d;
            --btn-primary-bg: #f6019d;
            --btn-primary-hover: #d40078;
            --btn-copy-bg: #9700cc;
            --btn-copy-hover: #7b00a3;
            --btn-export-bg: #11d18e;
            --btn-export-hover: #0da872;
            --btn-view-data-bg: #2de2e6;
            --btn-view-data-hover: #81f7f9;
            --error-bg: rgba(246, 1, 157, 0.2);
            --error-border: #f6019d;
            --tabulator-header-bg: var(--bg-input);
            --tabulator-row-bg: #1a001a;
            --tabulator-row-even-bg: #2a002a;
            --tabulator-border: var(--border-primary);
            --tabulator-text: var(--text-primary);
            --tabulator-footer-bg: var(--bg-input);
            --tabulator-pag-button-bg: var(--bg-input-secondary);
            --tabulator-pag-button-hover: #6a1b9a;
        }

        /* High Contrast Theme */
        .high-contrast {
            --bg-body: #000000;
            --bg-container: #000000;
            --bg-container-translucent: rgba(0, 0, 0, 0.5);
            --bg-input: #000000;
            --bg-input-secondary: #000000;
            --bg-code: #000000;
            --bg-disabled: #333333;
            --border-primary: #ffffff;
            --border-secondary: #ffffff;
            --text-primary: #ffffff;
            --text-secondary: #e5e5e5;
            --text-accent: #ffffff;
            --text-accent-hover: #cccccc;
            --text-heading: #ffffff;
            --text-error: #ffffff;
            --btn-primary-bg: #ffffff;
            --btn-primary-hover: #e5e5e5;
            --btn-copy-bg: #ffffff;
            --btn-copy-hover: #e5e5e5;
            --btn-export-bg: #ffffff;
            --btn-export-hover: #e5e5e5;
            --btn-view-data-bg: #ffffff;
            --btn-view-data-hover: #e5e5e5;
            --error-bg: #000000;
            --error-border: #ff0000;
            --tabulator-header-bg: #000;
            --tabulator-row-bg: #000;
            --tabulator-row-even-bg: #000;
            --tabulator-border: #fff;
            --tabulator-text: #fff;
            --tabulator-footer-bg: #000;
            --tabulator-pag-button-bg: #333;
            --tabulator-pag-button-hover: #555;
        }
        
        /* High contrast button text override */
        .high-contrast .btn-inverted-text {
            color: #000000 !important;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            width: 24px; 
            height: 24px; 
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
            will-change: transform;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Form elements */
        .input-section { 
            display: none; 
            margin-top: 1.5rem; 
            padding-top: 1.5rem; 
            border-top-width: 1px; 
            border-color: var(--border-primary); 
        }
        
        option[disabled] { 
            font-weight: bold; 
            background-color: var(--bg-input-secondary); 
        }

        /* Modal content styles */
        #readme-modal-content h2 { 
            border-bottom: 1px solid var(--border-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            margin-top: 1.25rem;
            font-size: 1.25rem;
            line-height: 1.75rem;
            border-color: var(--border-primary); 
            color: var(--text-accent); 
        }
        
        #readme-modal-content h3 { 
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
            line-height: 1.75rem;
            color: var(--text-primary); 
        }
        
        #readme-modal-content p, 
        #readme-modal-content li { 
            color: var(--text-secondary); 
        }
        
        #readme-modal-content a { 
            color: var(--text-accent); 
            text-decoration: underline;
        }
        
        #readme-modal-content a:hover { 
            text-decoration: underline;
        }
        
        #readme-modal-content ul, 
        #readme-modal-content ol { 
            margin-left: 1.25rem;
            list-style-type: disc;
        }
        
        #readme-modal-content ol { 
            list-style-type: decimal;
        }
        
        #readme-modal-content code { 
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.125rem 0.25rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: var(--btn-copy-bg); 
        }
        
        .readme-method { 
            margin-bottom: 1.5rem; 
        }

        /* Tabulator table styles */
        .tabulator {
            border-color: var(--border-primary);
            background-color: var(--bg-container);
            color: var(--text-primary);
        }
        
        .tabulator .tabulator-header {
            background-color: var(--tabulator-header-bg);
            border-bottom-color: var(--border-primary);
        }
        
        .tabulator .tabulator-header .tabulator-col {
            background-color: var(--tabulator-header-bg);
            color: var(--text-primary);
        }
        
        .tabulator .tabulator-tableHolder .tabulator-table .tabulator-row {
            background-color: var(--tabulator-row-bg);
            color: var(--text-primary);
        }
        
        .tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.tabulator-row-even {
            background-color: var(--tabulator-row-even-bg);
        }
        
        .tabulator .tabulator-footer {
            background-color: var(--tabulator-footer-bg);
            border-top-color: var(--border-primary);
        }
        
        .tabulator .tabulator-footer .tabulator-paginator button {
            background: var(--tabulator-pag-button-bg);
            color: var(--text-primary);
        }
        
        .tabulator .tabulator-footer .tabulator-paginator button:hover {
            background: var(--tabulator-pag-button-hover);
        }
    </style>
</head>
<body data-proxy="https://mozapi-proxy-server.vercel.app/api/getMozData" class="transition-colors duration-300 css-loading">

    <div class="w-full max-w-4xl mx-auto bg-[var(--bg-container-translucent)] backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border border-[var(--border-primary)] my-8">
        
        <header class="relative text-center mb-6">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Moz_logo.svg/177px-Moz_logo.svg.png" alt="Moz Logo" class="mx-auto h-12 mb-4" id="moz-logo" loading="lazy" decoding="async" width="177" height="48">
            <h1 class="text-3xl font-bold text-[var(--text-heading)]">Advanced Moz API Tool</h1>
            <p class="text-[var(--text-primary)] mt-2">Add your key and select an API method to get started.</p>
        </header>
        
        <section class="mb-6 bg-[var(--bg-input)] p-4 rounded-lg border border-[var(--border-secondary)]" aria-labelledby="api-key-heading">
            <h2 id="api-key-heading" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Moz API Key</h2>
            <div id="apiKeyDisplay" class="hidden items-center justify-between" role="status" aria-live="polite">
                <span id="apiKeyText" class="text-[var(--text-secondary)] font-mono"></span>
                <button id="editApiKeyBtn" class="text-sm text-[var(--text-accent)] hover:text-[var(--text-accent-hover)] font-semibold" aria-label="Edit API key">Edit</button>
            </div>
            <div id="apiKeyInputArea" class="flex items-center gap-2">
                <label for="apiKeyInput" class="sr-only">Enter your Moz API key</label>
                <input type="password" id="apiKeyInput" class="w-full bg-[var(--bg-body)] border border-[var(--border-secondary)] rounded-md px-3 py-2 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 ring-[var(--text-accent)]" placeholder="mozscape-1234abcd..." autocomplete="off" aria-describedby="api-key-help">
                <button id="saveApiKeyBtn" class="bg-[var(--btn-primary-bg)] hover:bg-[var(--btn-primary-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition btn-inverted-text" aria-label="Save API key">Save</button>
            </div>
            <div id="api-key-help" class="sr-only">Enter your Moz API key to access the API services</div>
            <!-- Quota Display Area -->
            <div id="quota-display" class="hidden mt-3 text-sm text-[var(--text-secondary)]" role="status" aria-live="polite">
                <span id="quota-text"></span>
            </div>
        </section>

        <section aria-labelledby="method-heading">
            <label for="methodSelector" id="method-heading" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">API Method</label>
            <select id="methodSelector" class="w-full bg-[var(--bg-input)] border border-[var(--border-secondary)] rounded-md px-3 py-2 focus:outline-none focus:ring-2 ring-[var(--text-accent)]" aria-describedby="method-help">
                <option value="" disabled selected>-- Select a Method --</option>
                <optgroup label="Site Metrics">
                    <option value="siteMetrics">Fetch Site Metrics</option>
                    <option value="brandAuthority">Fetch Brand Authority</option>
                    <option value="topPages">List Top Pages</option>
                </optgroup>
                 <optgroup label="Keyword Research">
                    <option value="keywordMetrics">Fetch Keyword Metrics</option>
                    <option value="searchIntent">Fetch Search Intent</option>
                    <option value="rankingKeywords">List Ranking Keywords</option>
                    <option value="relatedKeywords">List Related Keywords</option>
                    <option value="keywordCount">Count Ranking Keywords</option>
                </optgroup>
                <optgroup label="Link Building">
                    <option value="anchorText">Get Anchor Texts Lists</option>
                    <option value="linkingDomains">List Linking Domains</option>
                    <option value="recentlyGainedLinks">List Recently Gained Links</option>
                    <option value="recentlyLostLinks">List Recently Lost Links</option>
                    <option value="linkIntersect">Fetch Link Intersects</option>
                    <option value="listLinks">List Links</option>
                    <option value="filterLinksByAnchor">Filter Links by Anchor Text</option>
                    <option value="filterLinksByDomain">Filter Links by Domain</option>
                </optgroup>
                <optgroup label="Technical SEO">
                     <option value="finalRedirect">Get Final Redirect Target</option>
                     <option value="linkStatus">Get Link Status</option>
                </optgroup>
            </select>
            <div id="method-help" class="sr-only">Choose the Moz API method you want to use</div>
        </section>

        <form id="api-form" aria-label="API request form">
             <div id="inputsContainer" class="mt-4" role="region" aria-live="polite">
                <fieldset id="siteMetricsInputs" class="input-section space-y-4"><legend class="sr-only">Site Metrics Inputs</legend></fieldset>
                <fieldset id="keywordMetricsInputs" class="input-section space-y-4"><legend class="sr-only">Keyword Metrics Inputs</legend></fieldset>
                <fieldset id="brandAuthorityInputs" class="input-section space-y-4"><legend class="sr-only">Brand Authority Inputs</legend></fieldset>
                <fieldset id="searchIntentInputs" class="input-section space-y-4"><legend class="sr-only">Search Intent Inputs</legend></fieldset>
                <fieldset id="rankingKeywordsInputs" class="input-section space-y-4"><legend class="sr-only">Ranking Keywords Inputs</legend></fieldset>
                <fieldset id="relatedKeywordsInputs" class="input-section space-y-4"><legend class="sr-only">Related Keywords Inputs</legend></fieldset>
                <fieldset id="keywordCountInputs" class="input-section space-y-4"><legend class="sr-only">Keyword Count Inputs</legend></fieldset>
                <fieldset id="anchorTextInputs" class="input-section space-y-4"><legend class="sr-only">Anchor Text Inputs</legend></fieldset>
                <fieldset id="recentlyGainedLinksInputs" class="input-section space-y-4"><legend class="sr-only">Recently Gained Links Inputs</legend></fieldset>
                <fieldset id="recentlyLostLinksInputs" class="input-section space-y-4"><legend class="sr-only">Recently Lost Links Inputs</legend></fieldset>
                <fieldset id="linkingDomainsInputs" class="input-section space-y-4"><legend class="sr-only">Linking Domains Inputs</legend></fieldset>
                <fieldset id="finalRedirectInputs" class="input-section space-y-4"><legend class="sr-only">Final Redirect Inputs</legend></fieldset>
                <fieldset id="topPagesInputs" class="input-section space-y-4"><legend class="sr-only">Top Pages Inputs</legend></fieldset>
                <fieldset id="linkIntersectInputs" class="input-section space-y-4"><legend class="sr-only">Link Intersect Inputs</legend></fieldset>
                <fieldset id="listLinksInputs" class="input-section space-y-4"><legend class="sr-only">List Links Inputs</legend></fieldset>
                <fieldset id="linkStatusInputs" class="input-section space-y-4"><legend class="sr-only">Link Status Inputs</legend></fieldset>
                <fieldset id="filterLinksByAnchorInputs" class="input-section space-y-4"><legend class="sr-only">Filter Links by Anchor Inputs</legend></fieldset>
                <fieldset id="filterLinksByDomainInputs" class="input-section space-y-4"><legend class="sr-only">Filter Links by Domain Inputs</legend></fieldset>
            </div>
            <div class="mt-8 text-center">
                 <button type="submit" id="submit-btn" class="bg-[var(--btn-primary-bg)] hover:bg-[var(--btn-primary-hover)] text-white font-bold px-8 py-3 rounded-lg transition duration-300 flex items-center justify-center w-full md:w-auto md:min-w-[200px] mx-auto disabled:bg-[var(--bg-disabled)] disabled:cursor-not-allowed btn-inverted-text" aria-describedby="submit-help">
                    Run Request
                </button>
                <div id="submit-help" class="sr-only">Submit your API request with the selected method and parameters</div>
            </div>
        </form>

        <section id="status-container" class="mt-8" aria-live="polite">
            <div id="error-message" role="alert" class="hidden bg-[var(--error-bg)] border border-[var(--error-border)] text-[var(--text-error)] px-4 py-3 rounded-lg text-center"></div>
            <div id="results-container" class="hidden bg-[var(--bg-input)] p-4 md:p-6 rounded-xl border border-[var(--border-primary)]" role="region" aria-labelledby="results-heading">
                <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
                    <h2 id="results-heading" class="text-xl font-bold text-[var(--text-heading)]">API Results</h2>
                    <div class="flex items-center gap-2 flex-wrap justify-end" role="toolbar" aria-label="Results actions">
                        <button id="view-data-btn" class="bg-[var(--btn-view-data-bg)] hover:bg-[var(--btn-view-data-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text" aria-label="Toggle between table and JSON view">View Table</button>
                        <button id="filter-btn" class="bg-[var(--btn-view-data-bg)] hover:bg-[var(--btn-view-data-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text hidden" aria-label="Filter table data">Filter</button>
                        <button id="copy-json-btn" class="bg-[var(--btn-copy-bg)] hover:bg-[var(--btn-copy-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text" aria-label="Copy JSON data to clipboard">Copy JSON</button>
                        <button id="export-btn" class="bg-[var(--btn-export-bg)] hover:bg-[var(--btn-export-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text" aria-label="Export data as CSV file">Export to CSV</button>
                    </div>
                </div>
                <div id="active-filters-container" class="hidden mb-4 space-x-2" role="status" aria-live="polite"></div>
                <div id="raw-wrapper">
                    <pre class="whitespace-pre-wrap break-all text-sm bg-[var(--bg-code)] text-[var(--text-primary)] p-4 rounded-lg" role="region" aria-label="Raw JSON data"><code></code></pre>
                </div>
                <div id="table-wrapper" class="hidden overflow-x-auto" role="region" aria-label="Data table">
                    <div id="results-table"></div>
                </div>
            </div>
        </section>

        <footer class="text-center text-[var(--text-secondary)] text-sm mt-8 border-t border-[var(--border-primary)] pt-6">
            <div class="mb-4 flex justify-center items-center gap-2" role="toolbar" aria-label="Theme selection">
                <button data-theme="light" class="theme-btn p-2 rounded-lg" aria-label="Switch to light theme">Light</button>
                <button data-theme="dark" class="theme-btn p-2 rounded-lg" aria-label="Switch to dark theme">Dark</button>
                <button data-theme="retro" class="theme-btn p-2 rounded-lg" aria-label="Switch to retro theme">Retro</button>
                <button data-theme="high-contrast" class="theme-btn p-2 rounded-lg" aria-label="Switch to high contrast theme">High Contrast</button>
            </div>
            <p>&copy; Jonathan Berthold 2025</p>
            <nav class="mt-2 space-x-4" aria-label="External links">
                <a href="https://moz.com/api/dashboard" target="_blank" rel="noopener" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">API Dashboard</a>
                <span class="text-[var(--text-secondary)]" aria-hidden="true">|</span>
                <a href="https://moz.com/products/api/keys" target="_blank" rel="noopener" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">Get Moz API Key</a>
                <span class="text-[var(--text-secondary)]" aria-hidden="true">|</span>
                 <a href="https://moz.com/api/docs/welcome" target="_blank" rel="noopener" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">API Docs</a>
                <span class="text-[var(--text-secondary)]" aria-hidden="true">|</span>
                <button id="readme-btn" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]" aria-label="Open help documentation">Read Me</button>
            </nav>
        </footer>

    </div>

    <!-- Modals -->
    <div id="readme-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" role="dialog" aria-labelledby="readme-modal-title" aria-modal="true">
        <div class="bg-[var(--bg-container)] border border-[var(--border-primary)] w-full max-w-3xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-primary)]">
                <h2 id="readme-modal-title" class="text-lg font-semibold text-[var(--text-primary)]">Read Me / Help</h2>
                <button id="close-readme-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]" aria-label="Close help dialog">&times;</button>
            </div>
            <div id="readme-modal-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
     <div id="filter-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" role="dialog" aria-labelledby="filter-modal-title" aria-modal="true">
        <div class="bg-[var(--bg-container)] border border-[var(--border-primary)] w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-primary)]">
                <h2 id="filter-modal-title" class="text-lg font-semibold text-[var(--text-primary)]">Filter Data</h2>
                <button id="close-filter-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]" aria-label="Close filter dialog">&times;</button>
            </div>
            <div id="filter-fields-container" class="p-6 overflow-y-auto space-y-4"></div>
            <div class="p-4 border-t border-[var(--border-primary)] flex justify-end gap-2">
                <button id="cancel-filter-btn" class="bg-[var(--bg-input-secondary)] hover:bg-[var(--bg-disabled)] text-[var(--text-primary)] font-semibold px-4 py-2 text-sm rounded-md transition">Cancel</button>
                <button id="apply-filter-btn" class="bg-[var(--btn-primary-bg)] hover:bg-[var(--btn-primary-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition btn-inverted-text">Apply</button>
            </div>
        </div>
    </div>


    <script>
        // Performance optimization: Use requestAnimationFrame for DOM updates
        const raf = window.requestAnimationFrame || window.setTimeout;
        
        // Debounce function for better performance
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };
        
        // Data processing utilities - centralized to eliminate duplication
        const DataProcessor = {
            na: 'N/A',
            
            snakeToTitleCase: (s) => s.replace(/^_*(.)|_+(.)/g, (s, c, d) => c ? c.toUpperCase() : ' ' + d.toUpperCase()),
            
            processLinkMetrics: (linkItem, query, originalParams) => {
                const baseInfo = { 'Query': query, 'Scope': originalParams.scope };
                const metrics = linkItem.site_metrics || {};
                const otherData = { ...linkItem };
                delete otherData.site_metrics;
                const combined = { ...baseInfo, ...metrics, ...otherData };
                const titleCased = {};
                for (const key in combined) {
                    titleCased[DataProcessor.snakeToTitleCase(key)] = combined[key];
                }
                return titleCased;
            },
            
            processResults: (results, method, originalParams) => {
                const rows = [];
                
                results.forEach((res, i) => {
                    let query;
                    if (['linkIntersect', 'linkStatus', 'filterLinksByDomain'].includes(method)) {
                        query = 'N/A';
                    } else {
                        query = (originalParams.targets || originalParams.keywords)[i] || DataProcessor.na;
                    }
                    
                    if (res.status !== 'success') {
                        rows.push({ Query: query, Status: `Error: ${res.reason || 'Unknown'}` });
                        return;
                    }
                    
                    // Process each method type
                    const methodProcessors = {
                        siteMetrics: () => {
                            const metrics = res.data.site_metrics || {};
                            const orderedMetrics = {'Page Authority': metrics.page_authority, 'Domain Authority': metrics.domain_authority, 'Spam Score': metrics.spam_score };
                            for(const key in metrics){
                                if(!['page_authority', 'domain_authority', 'spam_score'].includes(key)) {
                                    orderedMetrics[DataProcessor.snakeToTitleCase(key)] = metrics[key];
                                }
                            }
                            return {'Query': res.data.site_query?.query || query, 'Scope': res.data.site_query?.scope || DataProcessor.na, 'Original Query': res.data.site_query?.original_site_query?.query || query, ...orderedMetrics };
                        },
                        
                        brandAuthority: () => ({'Site Query': res.data.site_query?.query || DataProcessor.na, 'Scope': res.data.site_query?.scope || DataProcessor.na, 'Brand Authority Score': res.data.site_metrics?.brand_authority_score ?? DataProcessor.na, 'Original Query': res.data.site_query?.original_site_query?.query || query }),
                        
                        topPages: () => {
                            const pages = [];
                            (res.data.top_pages || []).forEach(page => {
                                const pageData = { 'Query': query, 'Scope': originalParams.scope, ...page };
                                const titleCased = {};
                                for(const key in pageData) { titleCased[DataProcessor.snakeToTitleCase(key)] = pageData[key]; }
                                pages.push(titleCased);
                            });
                            if (!res.data.top_pages || res.data.top_pages.length === 0) pages.push({ Query: query, Status: 'No top pages found' });
                            return pages;
                        },
                        
                        keywordMetrics: () => {
                            const metricTypeMap = { 'all': 'All Keyword Metrics', 'volume': 'Search Volume', 'difficulty': 'Difficulty', 'opportunity': 'Organic CTR', 'priority': 'Priority' };
                            return {'Keyword': res.data.serp_query?.keyword || query, 'API Call': metricTypeMap[originalParams.metricType] || originalParams.metricType, 'Locale': res.data.serp_query?.locale || DataProcessor.na, 'Device': res.data.serp_query?.device || DataProcessor.na, 'Engine': res.data.serp_query?.engine || DataProcessor.na, 'Volume': res.data.keyword_metrics?.volume ?? DataProcessor.na, 'Difficulty': res.data.keyword_metrics?.difficulty ?? DataProcessor.na, 'Opportunity CTR': res.data.keyword_metrics?.organic_ctr ?? DataProcessor.na, 'Priority': res.data.keyword_metrics?.priority ?? DataProcessor.na };
                        },
                        
                        searchIntent: () => {
                            const intentData = {};
                            (res.data.keyword_intent?.all_intents || []).forEach(intent => {
                                intentData[`${DataProcessor.snakeToTitleCase(intent.label)} Score`] = intent.score ?? DataProcessor.na;
                            });
                            return {'Keyword': res.data.serp_query?.keyword || query, 'Locale': res.data.serp_query?.locale || DataProcessor.na, 'Device': res.data.serp_query?.device || DataProcessor.na, 'Engine': res.data.serp_query?.engine || DataProcessor.na, 'Primary Intent': (res.data.keyword_intent?.primary_intents || []).join(', ') || DataProcessor.na, ...intentData };
                        },
                        
                        rankingKeywords: () => {
                            const keywords = [];
                            const baseInfo = { 'Query': query, 'Scope': originalParams.scope, 'Locale': originalParams.locale };
                            if(res.data.ranking_keywords?.length > 0){
                                res.data.ranking_keywords.forEach(kw => { keywords.push({ ...baseInfo, 'Keyword': kw.keyword, 'Ranking Page': kw.ranking_page, 'Rank Position': kw.rank_position, 'Difficulty': kw.difficulty, 'Volume': kw.volume }); });
                            } else { keywords.push({ ...baseInfo, Status: 'No ranking keywords found' }); }
                            return keywords;
                        },
                        
                        relatedKeywords: () => {
                            const suggestions = [];
                            const baseInfo = { 'Keyword': query, 'Locale': res.data.serp_query?.locale, 'Device': res.data.serp_query?.device, 'Engine': res.data.serp_query?.engine };
                            if(res.data.suggestions?.length > 0){
                                res.data.suggestions.forEach(sug => { suggestions.push({ ...baseInfo, 'Suggested Keyword': sug.keyword, 'Relevance': sug.relevance }); });
                            } else { suggestions.push({ ...baseInfo, Status: 'No suggestions found' }); }
                            return suggestions;
                        },
                        
                        keywordCount: () => {
                            const positions = res.data.ranking_keyword_count?.position || {};
                            const rankCounts = {};
                            for (let i = 1; i <= 50; i++) {
                                rankCounts[`Rank ${i} Count`] = positions[`rank_${i}`] ?? 0;
                            }
                            return {'Query': query, 'Scope': originalParams.scope, 'Locale': originalParams.locale, 'Total Ranking Count': res.data.ranking_keyword_count?.total ?? DataProcessor.na, ...rankCounts };
                        },
                        
                        anchorText: () => {
                            const anchorTexts = [];
                            const baseInfo = { 'Query': query, 'Scope': originalParams.scope };
                            if(res.data.anchor_texts?.length > 0){
                                res.data.anchor_texts.forEach(at => { anchorTexts.push({ ...baseInfo, 'Anchor Text': at.text, 'External Root Domains': at.external_root_domains, 'External Pages': at.external_pages }); });
                            } else { anchorTexts.push({ ...baseInfo, Status: 'No anchor texts found' }); }
                            return anchorTexts;
                        },
                        
                        recentlyGainedLinks: () => {
                            const links = [];
                            (res.data.gained_linking_domains || []).forEach(link => links.push(DataProcessor.processLinkMetrics(link, query, originalParams)));
                            if (!res.data.gained_linking_domains || res.data.gained_linking_domains.length === 0) links.push({ Query: query, Status: 'No recently gained links found' });
                            return links;
                        },
                        
                        recentlyLostLinks: () => {
                            const links = [];
                            (res.data.lost_linking_domains || []).forEach(link => links.push(DataProcessor.processLinkMetrics(link, query, originalParams)));
                            if (!res.data.lost_linking_domains || res.data.lost_linking_domains.length === 0) links.push({ Query: query, Status: 'No recently lost links found' });
                            return links;
                        },
                        
                        linkingDomains: () => {
                            const links = [];
                            (res.data.linking_domains || []).forEach(link => links.push(DataProcessor.processLinkMetrics(link, query, originalParams)));
                            if (!res.data.linking_domains || res.data.linking_domains.length === 0) links.push({ Query: query, Status: 'No linking domains found' });
                            return links;
                        },
                        
                        finalRedirect: () => ({ 'Query': query, 'Scope': originalParams.scope, 'Original Query': res.data.site_query?.original_site_query?.query || query, 'Destination': res.data.destination || 'No redirect found' }),
                        
                        linkIntersect: () => {
                            const intersectData = res.data.link_intersects || [];
                            if (intersectData.length === 0) {
                                return [{ Status: 'No intersecting links found' }];
                            } else {
                                const intersects = [];
                                const baseInfo = {
                                    'Linking To': (res.data.is_linking_to || []).map(t => t.query).join(', '),
                                    'Not Linking To': (res.data.not_linking_to || []).map(t => t.query).join(', '),
                                    'Minimum Matching Targets': res.data.options?.minimum_matching_targets || DataProcessor.na,
                                    'Scope': res.data.options?.scope || DataProcessor.na,
                                    'Sort': res.data.options?.sort || DataProcessor.na
                                };
                                intersectData.forEach(intersect => {
                                    (intersect.matching_source_pages || [{page: 'N/A', page_authority: 'N/A'}]).forEach(sourcePage => {
                                        intersects.push({
                                            ...baseInfo,
                                            'Intersecting Domain': intersect.page,
                                            'Intersecting Title': intersect.title,
                                            'Intersecting DA': intersect.domain_authority,
                                            'Intersecting Spam Score': intersect.spam_score,
                                            'Matching Target Indexes': (intersect.matching_target_indexes || []).join(', '),
                                            'Source Page': sourcePage.page,
                                            'Source PA': sourcePage.page_authority
                                        });
                                    });
                                });
                                return intersects;
                            }
                        },
                        
                        listLinks: () => {
                            const links = [];
                            (res.data.links || []).forEach(link => {
                                const sourceMetrics = link.source_site_metrics || {};
                                const targetMetrics = link.target_site_metrics || {};
                                const linkInfo = { ...link };
                                delete linkInfo.source_site_metrics;
                                delete linkInfo.target_site_metrics;

                                const row = {};
                                for (const key in sourceMetrics) row[`Source ${DataProcessor.snakeToTitleCase(key)}`] = sourceMetrics[key];
                                for (const key in targetMetrics) row[`Target ${DataProcessor.snakeToTitleCase(key)}`] = targetMetrics[key];
                                for (const key in linkInfo) row[DataProcessor.snakeToTitleCase(key)] = linkInfo[key];
                                links.push(row);
                            });
                            if (!res.data.links || res.data.links.length === 0) links.push({ Query: query, Status: 'No links found' });
                            return links;
                        },
                        
                        filterLinksByAnchor: () => DataProcessor.methodProcessors.listLinks(),
                        filterLinksByDomain: () => DataProcessor.methodProcessors.listLinks(),
                        
                        linkStatus: () => ({ 'Target Query': res.data.target_site_query?.query, 'Source Query': res.data.source_site_query?.query, 'Exists': res.data.exists })
                    };
                    
                    const processor = methodProcessors[method];
                    if (processor) {
                        const result = processor();
                        if (Array.isArray(result)) {
                            rows.push(...result);
                        } else {
                            rows.push(result);
                        }
                    }
                });
                
                return rows;
            }
        };
        
        // Performance monitoring
        const performanceMonitor = {
            startTime: performance.now(),
            mark: (name) => performance.mark(name),
            measure: (name, start, end) => performance.measure(name, start, end),
            logMetrics: () => {
                const loadTime = performance.now() - performanceMonitor.startTime;
                console.log(`Page load time: ${loadTime.toFixed(2)}ms`);
            }
        };
        
        // Service Worker registration for caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker registration failed, continue without caching
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            performanceMonitor.mark('dom-ready');
            
            // Handle CSS loading state to prevent FOUC
            const handleCSSLoad = () => {
                document.body.classList.remove('css-loading');
                document.body.classList.add('css-loaded');
            };
            
            // Ensure CSS is loaded before showing content
            if (document.readyState === 'loading') {
                document.addEventListener('readystatechange', () => {
                    if (document.readyState === 'interactive' || document.readyState === 'complete') {
                        handleCSSLoad();
                    }
                });
            } else {
                // CSS already loaded
                handleCSSLoad();
            }
            
            // Fallback: Show content after a short delay if CSS hasn't loaded
            setTimeout(handleCSSLoad, 100);
            
            let currentResultsData = null;
            let currentOriginalParams = null;
            let currentMethod = null;
            let inFlightRequest = null;
            let table = null;
            let currentFilters = [];

            const allDOMElements = {
                apiKeyDisplay: document.getElementById('apiKeyDisplay'), 
                apiKeyText: document.getElementById('apiKeyText'), 
                editApiKeyBtn: document.getElementById('editApiKeyBtn'), 
                apiKeyInputArea: document.getElementById('apiKeyInputArea'), 
                apiKeyInput: document.getElementById('apiKeyInput'), 
                saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
                readmeBtn: document.getElementById('readme-btn'), 
                readmeModal: document.getElementById('readme-modal'),
                readmeModalContent: document.getElementById('readme-modal-content'), 
                closeReadmeBtn: document.getElementById('close-readme-btn'), 
                themeBtns: document.querySelectorAll('.theme-btn'), 
                methodSelector: document.getElementById('methodSelector'), 
                form: document.getElementById('api-form'), 
                submitBtn: document.getElementById('submit-btn'),
                errorMessage: document.getElementById('error-message'), 
                resultsContainer: document.getElementById('results-container'), 
                rawWrapper: document.getElementById('raw-wrapper'),
                tableWrapper: document.getElementById('table-wrapper'),
                rawCode: document.querySelector('#raw-wrapper code'), 
                exportBtn: document.getElementById('export-btn'), 
                copyJsonBtn: document.getElementById('copy-json-btn'),
                viewDataBtn: document.getElementById('view-data-btn'),
                filterBtn: document.getElementById('filter-btn'),
                filterModal: document.getElementById('filter-modal'),
                closeFilterBtn: document.getElementById('close-filter-btn'),
                cancelFilterBtn: document.getElementById('cancel-filter-btn'),
                filterFieldsContainer: document.getElementById('filter-fields-container'),
                applyFilterBtn: document.getElementById('apply-filter-btn'),
                activeFiltersContainer: document.getElementById('active-filters-container'),
                mozLogo: document.getElementById('moz-logo'),
                quotaDisplay: document.getElementById('quota-display'), 
                quotaText: document.getElementById('quota-text')
            };

            const populateInputs = () => {
                const createLabel = (text) => `<label class="block text-sm font-medium text-[var(--text-secondary)]">${text}</label>`;
                const createSelect = (id, options) => `<select id="${id}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">${options}</select>`;
                const createTextarea = (id, placeholder) => `<textarea id="${id}" rows="4" class="w-full bg-[var(--bg-input)] border border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)] placeholder-[var(--text-secondary)]" placeholder="${placeholder}"></textarea>`;
                const createDescription = text => `<p class="text-sm text-[var(--text-secondary)]">${text}</p>`;
                const createNumberInput = (id, value, min, max, label) => createLabel(label) + `<input type="number" id="${id}" value="${value}" min="${min}" max="${max}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">`;
                const createDateInput = (id) => `<input type="date" id="${id}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">`;
                const createMultiSelect = (id, options) => `<select id="${id}" multiple class="w-full h-32 bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">${options}</select>`;
                
                const scopeOptions = `<option value="domain" selected>Domain</option><option value="subdomain">Subdomain</option><option value="subfolder">Subfolder</option><option value="url">URL</option>`;
                const limitedScopeOptions = `<option value="domain" selected>Domain</option><option value="subdomain">Subdomain</option><option value="url">URL</option>`;
                const localeOptions = `<option value="en-US" selected>en-US</option><option value="en-CA">en-CA</option><option value="en-GB">en-GB</option><option value="en-AU">en-AU</option>`;
                const keywordMetricOptions = `<option value="all" selected>All Metrics</option><option value="volume">Search Volume</option><option value="difficulty">Difficulty</option><option value="opportunity">Organic CTR</option><option value="priority">Priority</option>`;
                const deviceOptions = `<option value="desktop" selected>Desktop</option><option value="mobile_android">Mobile Android</option><option value="mobile_ios">Mobile iOS</option>`;
                const engineOptions = `<option value="google" selected>Google</option><option value="bing">Bing</option><option value="yahoo">Yahoo</option>`;
                const topPagesFilterOptions = `<option value="all" selected>All</option><option value="status_200">Status 200</option><option value="status_301">Status 301</option><option value="status_302">Status 302</option><option value="status_4xx">Status 4xx</option><option value="status_5xx">Status 5xx</option>`;
                const topPagesSortOptions = `<option value="page_authority" selected>Page Authority</option><option value="root_domains_to_page">Linking Root Domains</option><option value="external_pages_to_page">External Linking Pages</option>`;
                const listLinksFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option><option value="not_deleted">not_deleted</option><option value="redirect">redirect</option><option value="not_redirect">not_redirect</option><option value="rel_canonical">rel_canonical</option><option value="not_rel_canonical">not_rel_canonical</option><option value="via_redirect">via_redirect</option><option value="not_via_redirect">not_via_redirect</option><option value="via_rel_canonical">via_rel_canonical</option><option value="not_via_rel_canonical">not_via_rel_canonical</option>`;
                const linkIntersectSortOptions = `<option value="matching_target_count" selected>Matching Target Count</option><option value="source_spam_score">Source Spam Score</option><option value="source_domain_authority">Source Domain Authority</option>`;
                const linkingDomainsSortOptions = `<option value="source_domain_authority" selected>Source Domain Authority</option><option value="source_link_propensity">Source Link Propensity</option><option value="source_spam_score">Source Spam Score</option>`;
                const linkingDomainsFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option>`;
                const listLinksSortOptions = `<option value="source_page_authority" selected>Source Page Authority</option><option value="source_domain_authority">Source Domain Authority</option><option value="source_link_propensity">Source Link Propensity</option><option value="source_spam_score">Source Spam Score</option>`;
                const filterAnchorSortOptions = `<option value="source_page_authority" selected>Source Page Authority</option><option value="source_domain_authority">Source Domain Authority</option><option value="source_link_propensity">Source Link Propensity</option><option value="source_spam_score">Source Spam Score</option>`;
                const filterAnchorFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option><option value="not_deleted">not_deleted</option><option value="redirect">redirect</option><option value="not_redirect">not_redirect</option><option value="rel_canonical">rel_canonical</option><option value="not_rel_canonical">not_rel_canonical</option><option value="via_redirect">via_redirect</option><option value="not_via_redirect">not_via_redirect</option><option value="via_rel_canonical">via_rel_canonical</option><option value="not_via_rel_canonical">not_via_rel_canonical</option>`;
                const filterDomainFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option>`;

                const limitLabel = 'Number of Results (Default 25; Choose from 1 to 50)';
                const limitLabelLarge = 'Number of Results (Default 25; Choose from 1 to 500)';

                document.getElementById('siteMetricsInputs').innerHTML = createDescription('Get metrics like DA, PA, Spam Score, and link counts for URLs.') + createLabel('Scope') + createSelect('smScopeSelect', scopeOptions) + createLabel('Domains / URLs') + createTextarea('smUrlsInput', 'One per line or comma-separated (must include http/https)');
                document.getElementById('keywordMetricsInputs').innerHTML = createDescription('Get volume, difficulty, CTR, and priority for keywords.') + createLabel('Metric Type') + createSelect('kmMetricTypeSelect', keywordMetricOptions) + createLabel('Device') + createSelect('kmDeviceSelect', deviceOptions) + createLabel('Engine') + createSelect('kmEngineSelect', engineOptions) + createLabel('Locale') + createSelect('kmLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('kmKeywordsInput', 'One per line or comma-separated');
                document.getElementById('brandAuthorityInputs').innerHTML = createDescription('Get the Brand Authority score for a given site.') + createLabel('Domains / URLs') + createTextarea('baUrlsInput', 'One per line or comma-separated.');
                document.getElementById('searchIntentInputs').innerHTML = createDescription('Retrieve search intent scores for any keyword.') + createLabel('Locale') + createSelect('siLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('siKeywordsInput', 'One per line or comma-separated.');
                document.getElementById('rankingKeywordsInputs').innerHTML = createDescription('List keywords for which a site ranks.') + createLabel('Scope') + createSelect('rkScopeSelect', scopeOptions) + createLabel('Locale') + createSelect('rkLocaleSelect', localeOptions) + createNumberInput('rkLimit', 25, 1, 500, limitLabelLarge) + createLabel('Domains / URLs') + createTextarea('rkUrlsInput', 'One per line or comma-separated.');
                document.getElementById('relatedKeywordsInputs').innerHTML = createDescription('Get a list of related keyword suggestions.') + createLabel('Locale') + createSelect('rlLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('rlKeywordsInput', 'One per line or comma-separated.');
                document.getElementById('keywordCountInputs').innerHTML = createDescription('Count keywords for which a site ranks in the top 50.') + createLabel('Scope') + createSelect('kcScopeSelect', limitedScopeOptions) + createLabel('Locale') + createSelect('kcLocaleSelect', localeOptions) + createLabel('Domains / URLs') + createTextarea('kcUrlsInput', 'One per line or comma-separated.');
                document.getElementById('anchorTextInputs').innerHTML = createDescription('Get data about anchor text used to link to a specified site.') + createLabel('Scope') + createSelect('atScopeSelect', scopeOptions) + createNumberInput('atLimit', 25, 1, 50, limitLabel) + createLabel('Domains / URLs') + createTextarea('atUrlsInput', 'One per line or comma-separated.');
                document.getElementById('recentlyGainedLinksInputs').innerHTML = createDescription('Get external root domains that added new links to a target during the past 60 days.') + createLabel('Scope') + createSelect('rglScopeSelect', scopeOptions) + createNumberInput('rglLimit', 25, 1, 50, limitLabel) + createLabel('Begin Date (Optional)') + createDateInput('rglBeginDate') + createLabel('End Date (Optional)') + createDateInput('rglEndDate') + createLabel('Domains / URLs') + createTextarea('rglUrlsInput', 'One per line or comma-separated.');
                document.getElementById('recentlyLostLinksInputs').innerHTML = createDescription('Get root domains that removed links to a target during the past 60 days.') + createLabel('Scope') + createSelect('rllScopeSelect', scopeOptions) + createNumberInput('rllLimit', 25, 1, 50, limitLabel) + createLabel('Begin Date (Optional)') + createDateInput('rllBeginDate') + createLabel('End Date (Optional)') + createDateInput('rllEndDate') + createLabel('Domains / URLs') + createTextarea('rllUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkingDomainsInputs').innerHTML = createDescription('Get a list of linking root domains to a target.') + createLabel('Scope') + createSelect('ldScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('ldSortSelect', linkingDomainsSortOptions) + createLabel('Filters') + createMultiSelect('ldFilterSelect', linkingDomainsFilterOptions) + createDescription('If providing multiple filters, "external" must be one of them.') + createNumberInput('ldLimit', 25, 1, 50, limitLabel) + createLabel('Domains / URLs') + createTextarea('ldUrlsInput', 'One per line or comma-separated.');
                document.getElementById('finalRedirectInputs').innerHTML = createDescription('See the final redirect target of a page.') + createLabel('Scope') + createSelect('frScopeSelect', scopeOptions) + createLabel('Domains / URLs') + createTextarea('frUrlsInput', 'One per line or comma-separated.');
                document.getElementById('topPagesInputs').innerHTML = createDescription('Return a list of the top pages on a target domain.') + createLabel('Scope') + createSelect('tpScopeSelect', scopeOptions) + createLabel('Filter') + createSelect('tpFilterSelect', topPagesFilterOptions) + createLabel('Sort') + createSelect('tpSortSelect', topPagesSortOptions) + createNumberInput('tpLimit', 25, 1, 50, limitLabel) + createLabel('Domains / URLs') + createTextarea('tpUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkIntersectInputs').innerHTML = createDescription('Find sites that link to some domains but not others.') + createLabel('Scope') + createSelect('liScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('liSortSelect', linkIntersectSortOptions) + createNumberInput('liMinMatch', 1, 1, 6, 'Minimum Matching Targets') + createNumberInput('liLimit', 25, 1, 50, limitLabel) + createLabel('Linking To') + createTextarea('liIsLinkingTo', 'One per line...') + createLabel('NOT Linking To (Optional)') + createTextarea('liNotLinkingTo', 'One per line...');
                document.getElementById('listLinksInputs').innerHTML = createDescription('Get a list of links to a target.') + createLabel('Scope') + createSelect('llScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('llSortSelect', listLinksSortOptions) + createLabel('Filters') + createMultiSelect('llFilterSelect', listLinksFilterOptions) + createDescription('If providing multiple filters, "external" must be one of them.') + createNumberInput('llLimit', 25, 1, 50, limitLabel) + createLabel('Domains / URLs') + createTextarea('llUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkStatusInputs').innerHTML = createDescription('Get the status of a link from a source to a target.') + createLabel('Target Scope') + createSelect('lsTargetScopeSelect', scopeOptions) + createLabel('Target URL') + createTextarea('lsTargetUrl', 'Target URL') + createLabel('Source Scope') + createSelect('lsSourceScopeSelect', scopeOptions) + createLabel('Source URL') + createTextarea('lsSourceUrl', 'Source URL');
                document.getElementById('filterLinksByAnchorInputs').innerHTML = createDescription('Get a list of links to a target where the anchor text exactly matches a string.') + createLabel('Scope') + createSelect('flaScopeSelect', scopeOptions) + createLabel('Anchor Text') + createTextarea('flaAnchorText', 'Enter exact anchor text...') + createLabel('Sort') + createSelect('flaSortSelect', filterAnchorSortOptions) + createLabel('Filters') + createMultiSelect('flaFilterSelect', filterAnchorFilterOptions) + createDescription('If providing multiple filters, "external" must be one of them.') + createNumberInput('flaLimit', 25, 1, 50, limitLabel) + createLabel('Domains / URLs') + createTextarea('flaUrlsInput', 'One per line or comma-separated.');
                document.getElementById('filterLinksByDomainInputs').innerHTML = createDescription('Find links pointing to a target only if they originate from a particular root domain.') + createLabel('Target Scope') + createSelect('fldTargetScopeSelect', scopeOptions) + createLabel('Target URLs') + createTextarea('fldTargetUrls', 'One per line...') + createLabel('Source Domain Scope') + createSelect('fldSourceScopeSelect', scopeOptions) + createLabel('Source Domain URLs') + createTextarea('fldSourceUrls', 'One per line...') + createLabel('Filters') + createMultiSelect('fldFilterSelect', filterDomainFilterOptions) + createDescription('If providing multiple filters, "external" must be one of them.') + createNumberInput('fldLimit', 25, 1, 50, limitLabel);
            };
            
            const readmeContent = `<h2>Moz API Assistant - Help</h2><h3>Overview</h3><p>This tool allows you to connect directly to the Moz API (v3) using your personal API key to fetch valuable SEO data.</p><h2>Setup</h2><ol><li><strong>Get API Key:</strong> You need a valid Moz API Key. You can get one or manage your existing key from the <a href="https://moz.com/products/api/keys" target="_blank" rel="noopener">Moz API Dashboard</a>.</li><li><strong>Add Key to Tool:</strong> Use the API Key input at the top of the tool. Your key is stored securely in your browser's local storage.</li></ol><h2>Features</h2><p>Select a method from the dropdown to get started:</p><hr class="border-slate-700 my-4">
                <div class="readme-method"><h3><strong><u>Fetch Site Metrics</u></strong></h3><ul><li><strong>Description:</strong> Get metrics like DA, PA, Spam Score, and link counts for URLs.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Fetch Brand Authority</u></strong></h3><ul><li><strong>Description:</strong> Get the Brand Authority score for a given site.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Top Pages</u></strong></h3><ul><li><strong>Description:</strong> Return a list of the top pages on a target domain.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Fetch Keyword Metrics</u></strong></h3><ul><li><strong>Description:</strong> Get volume, difficulty, CTR, and priority for keywords.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Fetch Search Intent</u></strong></h3><ul><li><strong>Description:</strong> Retrieve search intent scores for any keyword.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Ranking Keywords</u></strong></h3><ul><li><strong>Description:</strong> List keywords for which a site ranks.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Related Keywords</u></strong></h3><ul><li><strong>Description:</strong> Get a list of related keyword suggestions.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Count Ranking Keywords</u></strong></h3><ul><li><strong>Description:</strong> Count keywords for which a site ranks in the top 50.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Get Anchor Texts Lists</u></strong></h3><ul><li><strong>Description:</strong> Get data about anchor text used to link to a specified site.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Linking Domains</u></strong></h3><ul><li><strong>Description:</strong> Get a list of linking root domains to a target.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Recently Gained Links</u></strong></h3><ul><li><strong>Description:</strong> Get external root domains that added new links to a target during the past 60 days.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Recently Lost Links</u></strong></h3><ul><li><strong>Description:</strong> Get root domains that removed links to a target during the past 60 days.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Fetch Link Intersects</u></strong></h3><ul><li><strong>Description:</strong> Find sites that link to some domains but not others.</li></ul></div>
                <div class="readme-method"><h3><strong><u>List Links</u></strong></h3><ul><li><strong>Description:</strong> Get a list of links to a target.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Filter Links by Anchor Text</u></strong></h3><ul><li><strong>Description:</strong> Get a list of links to a target where the anchor text exactly matches a string.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Filter Links by Domain</u></strong></h3><ul><li><strong>Description:</strong> Find links pointing to a target only if they originate from a particular root domain.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Get Final Redirect Target</u></strong></h3><ul><li><strong>Description:</strong> See the final redirect target of a page.</li></ul></div>
                <div class="readme-method"><h3><strong><u>Get Link Status</u></strong></h3><ul><li><strong>Description:</strong> Get the status of a link from a source to a target.</li></ul></div>
                <hr class="border-slate-700 my-4"><h2>General Notes</h2><ul><li><strong>API Usage:</strong> Each API call consumes rows from your Moz API subscription quota. Be mindful of limits.</li><li><strong>Errors:</strong> If an API call fails, an error message will be displayed and the JSON response will contain details.</li></ul>`;
            
            const setupEventListeners = () => {
                allDOMElements.readmeBtn.addEventListener('click', () => allDOMElements.readmeModal.classList.remove('hidden'));
                allDOMElements.closeReadmeBtn.addEventListener('click', () => allDOMElements.readmeModal.classList.add('hidden'));
                allDOMElements.readmeModal.addEventListener('click', (e) => {
                    if (e.target === allDOMElements.readmeModal) allDOMElements.readmeModal.classList.add('hidden');
                });
                allDOMElements.themeBtns.forEach(btn => {
                    btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
                });
                allDOMElements.saveApiKeyBtn.addEventListener('click', () => {
                    const key = allDOMElements.apiKeyInput.value.trim();
                    if (key) {
                        try {
                            localStorage.setItem('mozApiKey', key);
                            loadApiKey();
                        } catch (e) {
                            console.warn('Could not save API key to localStorage:', e);
                            displayError('Could not save API key. Please try again.');
                        }
                    }
                });
                allDOMElements.editApiKeyBtn.addEventListener('click', () => {
                    allDOMElements.apiKeyDisplay.classList.add('hidden');
                    allDOMElements.apiKeyInputArea.classList.remove('hidden');
                    allDOMElements.apiKeyInput.focus();
                });
                allDOMElements.methodSelector.addEventListener('change', () => {
                    document.querySelectorAll('.input-section').forEach(section => section.style.display = 'none');
                    const selectedMethod = allDOMElements.methodSelector.value;
                    if (selectedMethod) {
                        const sectionToShow = document.getElementById(selectedMethod + 'Inputs');
                        if (sectionToShow) sectionToShow.style.display = 'block';
                        allDOMElements.submitBtn.disabled = false;
                    } else {
                        allDOMElements.submitBtn.disabled = true;
                    }
                });
                allDOMElements.form.addEventListener('submit', handleFormSubmit);
                allDOMElements.copyJsonBtn.addEventListener('click', handleCopyJson);
                allDOMElements.exportBtn.addEventListener('click', handleExportCsv);
                allDOMElements.viewDataBtn.addEventListener('click', toggleDataView);
                allDOMElements.filterBtn.addEventListener('click', () => allDOMElements.filterModal.classList.remove('hidden'));
                allDOMElements.closeFilterBtn.addEventListener('click', () => allDOMElements.filterModal.classList.add('hidden'));
                allDOMElements.cancelFilterBtn.addEventListener('click', () => allDOMElements.filterModal.classList.add('hidden'));
                allDOMElements.filterModal.addEventListener('click', (e) => {
                    if (e.target === allDOMElements.filterModal) allDOMElements.filterModal.classList.add('hidden');
                });
                allDOMElements.applyFilterBtn.addEventListener('click', applyTableFilters);
                
                // Add escape key functionality for modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!allDOMElements.readmeModal.classList.contains('hidden')) {
                            allDOMElements.readmeModal.classList.add('hidden');
                        }
                        if (!allDOMElements.filterModal.classList.contains('hidden')) {
                            allDOMElements.filterModal.classList.add('hidden');
                        }
                    }
                });
            };

            const applyTheme = (theme) => {
                raf(() => {
                    const root = document.documentElement;
                    const themes = ["light", "dark", "retro", "high-contrast"];
                    
                    // Remove all theme classes
                    themes.forEach(t => root.classList.remove(t));
                    
                    // Add new theme
                    root.classList.add(theme);
                    
                    // Save to localStorage
                    try {
                        localStorage.setItem('theme', theme);
                    } catch (e) {
                        console.warn('Could not save theme to localStorage:', e);
                    }
                    
                    // Update theme button states
                    allDOMElements.themeBtns.forEach(btn => {
                        btn.classList.toggle('font-bold', btn.dataset.theme === theme);
                    });
                    
                    // Reset logo filter
                    if (allDOMElements.mozLogo) {
                        allDOMElements.mozLogo.style.filter = 'none';
                    }
                });
            };

            const fetchQuota = async (apiKey) => {
                if (!apiKey) return;
                try {
                    // Add timeout to prevent hanging requests
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch('https://mozapi-proxy-server.vercel.app/api/getMozData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey, method: 'getQuota' }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.quota?.quota) {
                        throw new Error('Invalid quota data received');
                    }
                    
                    const { used, allotted } = data.quota.quota;
                    allDOMElements.quotaText.textContent = `API Usage: ${used.toLocaleString()} / ${allotted.toLocaleString()} Rows Used`;
                    allDOMElements.quotaText.style.color = used >= allotted ? 'var(--text-error)' : 'var(--text-secondary)';
                    allDOMElements.quotaDisplay.classList.remove('hidden');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn("Quota fetch error:", error);
                    }
                    allDOMElements.quotaText.textContent = 'Could not retrieve API usage.';
                    allDOMElements.quotaDisplay.classList.remove('hidden');
                }
            };
            
            const loadApiKey = () => {
                try {
                    const savedKey = localStorage.getItem('mozApiKey');
                    if (savedKey) {
                        allDOMElements.apiKeyText.textContent = `${savedKey.substring(0, 6)}...${savedKey.substring(savedKey.length - 4)}`;
                        allDOMElements.apiKeyInput.value = savedKey;
                        allDOMElements.apiKeyDisplay.classList.remove('hidden');
                        allDOMElements.apiKeyDisplay.classList.add('flex');
                        allDOMElements.apiKeyInputArea.classList.add('hidden');
                        fetchQuota(savedKey);
                    } else {
                        allDOMElements.apiKeyDisplay.classList.add('hidden');
                        allDOMElements.apiKeyInputArea.classList.remove('hidden');
                        allDOMElements.quotaDisplay.classList.add('hidden');
                    }
                } catch (e) {
                    console.warn('Could not load API key from localStorage:', e);
                    allDOMElements.apiKeyDisplay.classList.add('hidden');
                    allDOMElements.apiKeyInputArea.classList.remove('hidden');
                    allDOMElements.quotaDisplay.classList.add('hidden');
                }
            };
            
            async function handleFormSubmit(e) {
                e.preventDefault();

                // Prevent double submissions
                if (inFlightRequest) {
                    inFlightRequest.abort();
                }
                inFlightRequest = new AbortController();


                allDOMElements.errorMessage.classList.add('hidden');
                allDOMElements.resultsContainer.classList.add('hidden');
                allDOMElements.submitBtn.disabled = true;
                allDOMElements.submitBtn.setAttribute('aria-busy', 'true');
                allDOMElements.submitBtn.innerHTML = '<div class="spinner"></div><span class="ml-2">Processing...</span>';
                const apiKey = allDOMElements.apiKeyInput.value.trim();
                const selectedMethod = allDOMElements.methodSelector.value;
                if (!apiKey || !selectedMethod) {
                    displayError('Please provide an API Key and select a method.');
                    resetSubmitButton(); return;
                }
                let payload;
                try {
                    payload = buildPayload(apiKey, selectedMethod);
                } catch (error) {
                    displayError(error.message);
                    resetSubmitButton(); return;
                }
                const PROXY_URL = document.body.dataset.proxy;
                try {
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: inFlightRequest.signal
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Request failed with status ${response.status}`);
                    currentResultsData = data;
                    currentOriginalParams = payload.params;
                    currentMethod = selectedMethod;
                    showRawJsonResults(data);
                    fetchQuota(apiKey);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        displayError(error.message);
                    }
                } finally {
                    resetSubmitButton();
                    inFlightRequest = null;
                }
            }

            function handleCopyJson() {
                if (allDOMElements.rawCode.textContent) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(allDOMElements.rawCode.textContent).then(() => {
                            allDOMElements.copyJsonBtn.textContent = 'Copied!';
                            setTimeout(() => { allDOMElements.copyJsonBtn.textContent = 'Copy JSON'; }, 2000);
                        }, () => {
                            displayError('Failed to copy JSON.');
                        });
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = allDOMElements.rawCode.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            allDOMElements.copyJsonBtn.textContent = 'Copied!';
                            setTimeout(() => { allDOMElements.copyJsonBtn.textContent = 'Copy JSON'; }, 2000);
                        } catch (e) {
                            displayError('Failed to copy JSON.');
                        }
                        document.body.removeChild(textArea);
                    }
                }
            }
            
            function handleExportCsv() {
                 if (currentResultsData) {
                    exportDataToCsv(currentResultsData, currentMethod, currentOriginalParams);
                } else {
                    displayError("No data available to export.");
                }
            }

            function toggleDataView() {
                const isTableVisible = !allDOMElements.tableWrapper.classList.contains('hidden');
                if (isTableVisible) {
                    allDOMElements.tableWrapper.classList.add('hidden');
                    allDOMElements.rawWrapper.classList.remove('hidden');
                    allDOMElements.viewDataBtn.textContent = 'View Table';
                    allDOMElements.filterBtn.classList.add('hidden');
                } else {
                    allDOMElements.rawWrapper.classList.add('hidden');
                    allDOMElements.tableWrapper.classList.remove('hidden');
                    allDOMElements.viewDataBtn.textContent = 'View JSON';
                    allDOMElements.filterBtn.classList.remove('hidden');
                    renderTable(currentResultsData, currentMethod, currentOriginalParams);
                }
            }
            
            function showRawJsonResults(data) {
                allDOMElements.rawCode.textContent = JSON.stringify(data, null, 2);
                allDOMElements.resultsContainer.classList.remove('hidden');
                allDOMElements.tableWrapper.classList.add('hidden');
                allDOMElements.rawWrapper.classList.remove('hidden');
                allDOMElements.viewDataBtn.textContent = 'View Table';
            }

            function displayError(message) {
                 const hints = /quota|limit/i.test(message) ? 'You may be out of rows. Check your API Dashboard.' :
                              /unauthorized|401|403/i.test(message) ? 'Invalid API key. Recheck or regenerate in your dashboard.' :
                              /network|abort/i.test(message) ? 'Network hiccup or request was canceled. Try again.' : '';
                allDOMElements.errorMessage.innerHTML = `${message}${hints ? `<br><span class="text-[var(--text-secondary)]">${hints}</span>` : ''}`;
                allDOMElements.errorMessage.classList.remove('hidden');
            }
            
            function resetSubmitButton() {
                allDOMElements.submitBtn.disabled = allDOMElements.methodSelector.value === "";
                allDOMElements.submitBtn.innerHTML = 'Run Request';
                allDOMElements.submitBtn.removeAttribute('aria-busy');
            }

            function buildPayload(apiKey, selectedMethod) {
                let payload = { apiKey, method: selectedMethod, params: {} };
                const getInputValue = (id) => document.getElementById(id)?.value;
                const getCleanedList = (id) => getInputValue(id)?.split(/[\n,]/).map(item => item.trim()).filter(Boolean);
                const getSelectedOptions = (id) => Array.from(document.getElementById(id).selectedOptions).map(({ value }) => value);

                switch (selectedMethod) {
                    case 'siteMetrics': payload.params = { scope: getInputValue('smScopeSelect'), targets: getCleanedList('smUrlsInput') }; break;
                    case 'keywordMetrics': payload.params = { metricType: getInputValue('kmMetricTypeSelect'), device: getInputValue('kmDeviceSelect'), engine: getInputValue('kmEngineSelect'), locale: getInputValue('kmLocaleSelect'), keywords: getCleanedList('kmKeywordsInput') }; break;
                    case 'brandAuthority': payload.params = { targets: getCleanedList('baUrlsInput') }; break;
                    case 'searchIntent': payload.params = { locale: getInputValue('siLocaleSelect'), keywords: getCleanedList('siKeywordsInput') }; break;
                    case 'rankingKeywords': payload.params = { scope: getInputValue('rkScopeSelect'), locale: getInputValue('rkLocaleSelect'), targets: getCleanedList('rkUrlsInput'), limit: parseInt(getInputValue('rkLimit'), 10) || 25 }; break;
                    case 'relatedKeywords': payload.params = { locale: getInputValue('rlLocaleSelect'), keywords: getCleanedList('rlKeywordsInput') }; break;
                    case 'keywordCount': payload.params = { scope: getInputValue('kcScopeSelect'), locale: getInputValue('kcLocaleSelect'), targets: getCleanedList('kcUrlsInput') }; break;
                    case 'anchorText': payload.params = { scope: getInputValue('atScopeSelect'), targets: getCleanedList('atUrlsInput'), limit: parseInt(getInputValue('atLimit'), 10) || 25 }; break;
                    case 'recentlyGainedLinks': payload.params = { scope: getInputValue('rglScopeSelect'), targets: getCleanedList('rglUrlsInput'), limit: parseInt(getInputValue('rglLimit'), 10) || 25, beginDate: getInputValue('rglBeginDate'), endDate: getInputValue('rglEndDate') }; break;
                    case 'recentlyLostLinks': payload.params = { scope: getInputValue('rllScopeSelect'), targets: getCleanedList('rllUrlsInput'), limit: parseInt(getInputValue('rllLimit'), 10) || 25, beginDate: getInputValue('rllBeginDate'), endDate: getInputValue('rllEndDate') }; break;
                    case 'linkingDomains': payload.params = { scope: getInputValue('ldScopeSelect'), targets: getCleanedList('ldUrlsInput'), limit: parseInt(getInputValue('ldLimit'), 10) || 25, sort: getInputValue('ldSortSelect'), filters: getSelectedOptions('ldFilterSelect')}; break;
                    case 'finalRedirect': payload.params = { scope: getInputValue('frScopeSelect'), targets: getCleanedList('frUrlsInput') }; break;
                    case 'topPages': payload.params = { scope: getInputValue('tpScopeSelect'), targets: getCleanedList('tpUrlsInput'), limit: parseInt(getInputValue('tpLimit'), 10) || 25, filter: getInputValue('tpFilterSelect'), sort: getInputValue('tpSortSelect') }; break;
                    case 'linkIntersect': {
                        const intersectScope = getInputValue('liScopeSelect');
                        payload.params = { 
                            scope: intersectScope, 
                            limit: parseInt(getInputValue('liLimit'), 10) || 25, 
                            is_linking_to: getCleanedList('liIsLinkingTo').map(q => ({query: q, scope: intersectScope})), 
                            not_linking_to: getCleanedList('liNotLinkingTo').map(q => ({query: q, scope: intersectScope})), 
                            sort: getInputValue('liSortSelect'), 
                            minimum_matching_targets: parseInt(getInputValue('liMinMatch'), 10) || 1 
                        }; 
                        break;
                    }
                    case 'listLinks': payload.params = { scope: getInputValue('llScopeSelect'), targets: getCleanedList('llUrlsInput'), limit: parseInt(getInputValue('llLimit'), 10) || 25, filters: getSelectedOptions('llFilterSelect'), sort: getInputValue('llSortSelect') }; break;
                    case 'linkStatus': payload.params = { targetScope: getInputValue('lsTargetScopeSelect'), targetQuery: getInputValue('lsTargetUrl'), sourceScope: getInputValue('lsSourceScopeSelect'), sourceQuery: getInputValue('lsSourceUrl') }; break;
                    case 'filterLinksByAnchor': payload.params = { scope: getInputValue('flaScopeSelect'), targets: getCleanedList('flaUrlsInput'), anchorText: getInputValue('flaAnchorText'), limit: parseInt(getInputValue('flaLimit'), 10) || 25, filters: getSelectedOptions('flaFilterSelect'), sort: getInputValue('flaSortSelect') }; break;
                    case 'filterLinksByDomain': payload.params = { targetScope: getInputValue('fldTargetScopeSelect'), targetQueries: getCleanedList('fldTargetUrls'), sourceScope: getInputValue('fldSourceScopeSelect'), sourceQueries: getCleanedList('fldSourceUrls'), limit: parseInt(getInputValue('fldLimit'), 10) || 25, filters: getSelectedOptions('fldFilterSelect')}; break;
                    default: throw new Error('Invalid method selected.');
                }
                
                if (['siteMetrics', 'keywordMetrics', 'brandAuthority', 'searchIntent', 'rankingKeywords', 'relatedKeywords', 'keywordCount', 'anchorText', 'recentlyGainedLinks', 'recentlyLostLinks', 'linkingDomains', 'finalRedirect', 'topPages', 'listLinks', 'filterLinksByAnchor'].includes(selectedMethod)) {
                    if ((payload.params.targets?.length === 0) && (payload.params.keywords?.length === 0)) {
                        throw new Error('Please enter at least one URL or Keyword.');
                    }
                }
                 if (selectedMethod === 'linkIntersect' && payload.params.is_linking_to.length === 0) {
                     throw new Error('Please enter at least one URL for "Linking To".');
                 }
                 if (selectedMethod === 'linkStatus' && (!payload.params.targetQuery || !payload.params.sourceQuery)) {
                    throw new Error('Please enter both a Target and Source URL for Link Status.');
                 }
                return payload;
            }
             
            function exportDataToCsv(results, method, originalParams) {
                const rows = DataProcessor.processResults(results, method, originalParams);
                if (rows.length === 0) { displayError("No valid data to export."); return; }
                
                const allKeys = [...new Set(rows.flatMap(row => Object.keys(row)))];
                const header = allKeys.join(',');
                const csvRows = rows.map(row => allKeys.map(key => {
                    const value = row[key] === undefined || row[key] === null ? '' : row[key];
                    const stringValue = String(value);
                    if (stringValue.includes(',') || stringValue.includes('"')) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    return stringValue;
                }).join(','));
                const csvString = '\uFEFF' + [header, ...csvRows].join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `moz-api-results-${method}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function renderTable(results, method, originalParams) {
                if (table) {
                    table.destroy();
                }
                
                const rows = DataProcessor.processResults(results, method, originalParams);
                
                if (rows.length > 0) {
                    const allKeys = [...new Set(rows.flatMap(row => Object.keys(row)))];
                    const columns = allKeys.map(key => ({ title: key, field: key }));
                    
                    table = new Tabulator("#results-table", {
                        data: rows,
                        columns: columns,
                        layout: "fitDataFill",
                        pagination: "local",
                        paginationSize: 100,
                        movableColumns: true,
                        resizableRows: false,
                    });

                    allDOMElements.filterFieldsContainer.innerHTML = '';
                    columns.forEach(col => {
                        if (col.field) {
                            const div = document.createElement('div');
                            const label = document.createElement('label');
                            label.textContent = col.title;
                            label.className = 'block text-sm font-medium text-[var(--text-secondary)]';
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.dataset.field = col.field;
                            input.className = 'w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]';
                            div.appendChild(label);
                            div.appendChild(input);
                            allDOMElements.filterFieldsContainer.appendChild(div);
                        }
                    });
                }
            }

            function applyTableFilters() {
                const filterInputs = allDOMElements.filterFieldsContainer.querySelectorAll('input');
                currentFilters = [];
                filterInputs.forEach(input => {
                    if (input.value) {
                        currentFilters.push({
                            field: input.dataset.field,
                            type: 'like',
                            value: input.value
                        });
                    }
                });
                table.setFilter(currentFilters);
                updateActiveFilterChips();
                allDOMElements.filterModal.classList.add('hidden');
            }

            function updateActiveFilterChips() {
                allDOMElements.activeFiltersContainer.innerHTML = '';
                if (currentFilters.length > 0) {
                    const title = document.createElement('span');
                    title.className = 'text-sm font-bold text-[var(--text-secondary)]';
                    title.textContent = 'Active Filters:';
                    allDOMElements.activeFiltersContainer.appendChild(title);

                    currentFilters.forEach((filter, index) => {
                        const chip = document.createElement('span');
                        chip.className = 'inline-flex items-center px-2 py-1 bg-[var(--bg-input-secondary)] text-sm rounded-full';
                        chip.textContent = `${filter.field}: "${filter.value}"`;
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'ml-2 text-[var(--text-accent)]';
                        closeBtn.innerHTML = '&times;';
                        closeBtn.onclick = () => {
                            currentFilters.splice(index, 1);
                            table.setFilter(currentFilters);
                            updateActiveFilterChips();
                        };
                        chip.appendChild(closeBtn);
                        allDOMElements.activeFiltersContainer.appendChild(chip);
                    });
                    allDOMElements.activeFiltersContainer.classList.remove('hidden');
                } else {
                    allDOMElements.activeFiltersContainer.classList.add('hidden');
                }
            }

            // Initial calls
            allDOMElements.readmeModalContent.innerHTML = readmeContent;
            populateInputs();
            setupEventListeners();
            loadApiKey();
            allDOMElements.submitBtn.disabled = true;
            
            // Performance monitoring
            performanceMonitor.mark('init-complete');
            performanceMonitor.measure('initialization', 'dom-ready', 'init-complete');
            
            // Log performance metrics after a short delay
            setTimeout(() => {
                performanceMonitor.logMetrics();
            }, 100);

        });
    </script>
</body>
</html>
