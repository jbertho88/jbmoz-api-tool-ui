<!DOCTYPE html>
<html lang="en"> <!-- Theme class will be added here by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Advanced Moz API Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Theme Variables --- */
        :root, .light {
            --bg-body: #f9fafb;
            --bg-container: #ffffff;
            --bg-container-translucent: rgba(255, 255, 255, 0.5);
            --bg-input: #f3f4f6;
            --bg-input-secondary: #e5e7eb;
            --bg-code: #fefce8;
            --bg-disabled: #d1d5db;
            --border-primary: #e5e7eb;
            --border-secondary: #d1d5db;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-accent: #0284c7;
            --text-accent-hover: #0369a1;
            --text-heading: #0ea5e9;
            --text-error: #b91c1c;
            --btn-primary-bg: #002F50;
            --btn-primary-hover: #001d30;
            --btn-copy-bg: #f97316;
            --btn-copy-hover: #ea580c;
            --btn-export-bg: #10b981;
            --btn-export-hover: #059669;
            --error-bg: #fee2e2;
            --error-border: #fca5a5;
        }

        .dark {
            --bg-body: #020617;
            --bg-container: #1e293b;
            --bg-container-translucent: rgba(30, 41, 59, 0.5);
            --bg-input: #0f172a;
            --bg-input-secondary: #334155;
            --bg-code: #000000;
            --bg-disabled: #475569;
            --border-primary: #334155;
            --border-secondary: #475569;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-accent: #38bdf8;
            --text-accent-hover: #7dd3fc;
            --text-heading: #38bdf8;
            --text-error: #f87171;
            --btn-primary-bg: #0ea5e9;
            --btn-primary-hover: #38bdf8;
            --btn-copy-bg: #f97316;
            --btn-copy-hover: #fb923c;
            --btn-export-bg: #10b981;
            --btn-export-hover: #34d399;
            --error-bg: rgba(153, 27, 27, 0.5);
            --error-border: #ef4444;
        }

        .retro {
            --bg-body: #000000;
            --bg-container: #1a001a;
            --bg-container-translucent: rgba(26, 0, 26, 0.5);
            --bg-input: #2a002a;
            --bg-input-secondary: #3d003d;
            --bg-code: #000000;
            --bg-disabled: #4a148c;
            --border-primary: #4a148c;
            --border-secondary: #6a1b9a;
            --text-primary: #e0e0e0;
            --text-secondary: #ad5eda;
            --text-accent: #2de2e6;
            --text-accent-hover: #81f7f9;
            --text-heading: #9700cc;
            --text-error: #f6019d;
            --btn-primary-bg: #f6019d;
            --btn-primary-hover: #d40078;
            --btn-copy-bg: #9700cc;
            --btn-copy-hover: #7b00a3;
            --btn-export-bg: #11d18e;
            --btn-export-hover: #0da872;
            --error-bg: rgba(246, 1, 157, 0.2);
            --error-border: #f6019d;
        }

        .high-contrast {
            --bg-body: #000000;
            --bg-container: #000000;
            --bg-container-translucent: rgba(0, 0, 0, 0.5);
            --bg-input: #000000;
            --bg-input-secondary: #000000;
            --bg-code: #000000;
            --bg-disabled: #333333;
            --border-primary: #ffffff;
            --border-secondary: #ffffff;
            --text-primary: #ffffff;
            --text-secondary: #e5e5e5;
            --text-accent: #ffffff;
            --text-accent-hover: #cccccc;
            --text-heading: #ffffff;
            --text-error: #ffffff;
            --btn-primary-bg: #ffffff;
            --btn-primary-hover: #e5e5e5;
            --btn-copy-bg: #ffffff;
            --btn-copy-hover: #e5e5e5;
            --btn-export-bg: #ffffff;
            --btn-export-hover: #e5e5e5;
            --error-bg: #000000;
            --error-border: #ff0000;
        }
        /* Special text colors for high-contrast buttons */
        .high-contrast .btn-inverted-text {
            color: #000000 !important;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            width: 24px; height: 24px; border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .input-section { display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top-width: 1px; border-color: var(--border-primary); }
        option[disabled] { font-weight: bold; background-color: var(--bg-input-secondary); }

        /* Read Me Modal Styles */
        #readme-modal-content h2 { @apply border-b pb-2 mb-4 mt-5 text-xl; border-color: var(--border-primary); color: var(--text-accent); }
        #readme-modal-content h3 { @apply mt-5 mb-2 text-lg; color: var(--text-primary); }
        #readme-modal-content p, #readme-modal-content li { color: var(--text-secondary); }
        #readme-modal-content a { color: var(--text-accent); @apply hover:underline; }
        #readme-modal-content ul, #readme-modal-content ol { @apply ml-5 list-disc; }
        #readme-modal-content ol { @apply list-decimal; }
        #readme-modal-content code { @apply bg-black/50 px-1 py-0.5 rounded-md text-sm; color: var(--btn-copy-bg); }
        .readme-method { margin-bottom: 1.5rem; }
    </style>
</head>
<body class="transition-colors duration-300">

    <div class="w-full max-w-4xl mx-auto bg-[var(--bg-container-translucent)] backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border border-[var(--border-primary)] my-8">
        
        <div class="relative text-center mb-6">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Moz_logo.svg/177px-Moz_logo.svg.png" alt="Moz Logo" class="mx-auto h-12 mb-4" id="moz-logo">
            <h1 class="text-3xl font-bold text-[var(--text-heading)]">Advanced Moz API Tool</h1>
            <p class="text-[var(--text-primary)] mt-2">Add your key and select an API method to get started.</p>
        </div>
        
        <div class="mb-6 bg-[var(--bg-input)] p-4 rounded-lg border border-[var(--border-secondary)]">
            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Moz API Key</label>
            <div id="apiKeyDisplay" class="hidden items-center justify-between">
                <span id="apiKeyText" class="text-[var(--text-secondary)] font-mono"></span>
                <button id="editApiKeyBtn" class="text-sm text-[var(--text-accent)] hover:text-[var(--text-accent-hover)] font-semibold">Edit</button>
            </div>
            <div id="apiKeyInputArea" class="flex items-center gap-2">
                <input type="password" id="apiKeyInput" class="w-full bg-[var(--bg-body)] border border-[var(--border-secondary)] rounded-md px-3 py-2 text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 ring-[var(--text-accent)]" placeholder="mozscape-1234abcd...">
                <button id="saveApiKeyBtn" class="bg-[var(--btn-primary-bg)] hover:bg-[var(--btn-primary-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition btn-inverted-text">Save</button>
            </div>
            <!-- Quota Display Area -->
            <div id="quota-display" class="hidden mt-3 text-sm text-[var(--text-secondary)]">
                <span id="quota-text"></span>
            </div>
        </div>

        <div>
            <label for="methodSelector" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">API Method</label>
            <select id="methodSelector" class="w-full bg-[var(--bg-input)] border border-[var(--border-secondary)] rounded-md px-3 py-2 focus:outline-none focus:ring-2 ring-[var(--text-accent)]">
                <option value="" disabled selected>-- Select a Method --</option>
                <optgroup label="Site Metrics">
                    <option value="siteMetrics">Fetch Site Metrics</option>
                    <option value="brandAuthority">Fetch Brand Authority</option>
                    <option value="topPages">List Top Pages</option>
                </optgroup>
                 <optgroup label="Keyword Research">
                    <option value="keywordMetrics">Fetch Keyword Metrics</option>
                    <option value="searchIntent">Fetch Search Intent</option>
                    <option value="rankingKeywords">List Ranking Keywords</option>
                    <option value="relatedKeywords">List Related Keywords</option>
                    <option value="keywordCount">Count Ranking Keywords</option>
                </optgroup>
                <optgroup label="Link Building">
                    <option value="anchorText">Get Anchor Texts Lists</option>
                    <option value="linkingDomains">List Linking Domains</option>
                    <option value="recentlyGainedLinks">List Recently Gained Links</option>
                    <option value="recentlyLostLinks">List Recently Lost Links</option>
                    <option value="linkIntersect">Fetch Link Intersects</option>
                    <option value="listLinks">List Links</option>
                </optgroup>
                <optgroup label="Technical SEO">
                     <option value="finalRedirect">Get Final Redirect Target</option>
                     <option value="linkStatus">Get Link Status</option>
                </optgroup>
            </select>
        </div>

        <form id="api-form">
            <div id="inputsContainer" class="mt-4">
                <div id="siteMetricsInputs" class="input-section space-y-4"></div>
                <div id="keywordMetricsInputs" class="input-section space-y-4"></div>
                <div id="brandAuthorityInputs" class="input-section space-y-4"></div>
                <div id="searchIntentInputs" class="input-section space-y-4"></div>
                <div id="rankingKeywordsInputs" class="input-section space-y-4"></div>
                <div id="relatedKeywordsInputs" class="input-section space-y-4"></div>
                <div id="keywordCountInputs" class="input-section space-y-4"></div>
                <div id="anchorTextInputs" class="input-section space-y-4"></div>
                <div id="recentlyGainedLinksInputs" class="input-section space-y-4"></div>
                <div id="recentlyLostLinksInputs" class="input-section space-y-4"></div>
                <div id="linkingDomainsInputs" class="input-section space-y-4"></div>
                <div id="finalRedirectInputs" class="input-section space-y-4"></div>
                <div id="topPagesInputs" class="input-section space-y-4"></div>
                <div id="linkIntersectInputs" class="input-section space-y-4"></div>
                <div id="listLinksInputs" class="input-section space-y-4"></div>
                <div id="linkStatusInputs" class="input-section space-y-4"></div>
            </div>
            <div class="mt-8 text-center">
                 <button type="submit" id="submit-btn" class="bg-[var(--btn-primary-bg)] hover:bg-[var(--btn-primary-hover)] text-white font-bold px-8 py-3 rounded-lg transition duration-300 flex items-center justify-center w-full md:w-auto md:min-w-[200px] mx-auto disabled:bg-[var(--bg-disabled)] disabled:cursor-not-allowed btn-inverted-text">
                    Run Request
                </button>
            </div>
        </form>

        <div id="status-container" class="mt-8">
            <div id="error-message" class="hidden bg-[var(--error-bg)] border border-[var(--error-border)] text-[var(--text-error)] px-4 py-3 rounded-lg text-center"></div>
            <div id="results-container" class="hidden bg-[var(--bg-input)] p-4 md:p-6 rounded-xl border border-[var(--border-primary)]">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-[var(--text-heading)]">API Results</h2>
                    <div class="flex items-center gap-2">
                        <button id="copy-json-btn" class="bg-[var(--btn-copy-bg)] hover:bg-[var(--btn-copy-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text">Copy JSON</button>
                        <button id="export-btn" class="bg-[var(--btn-export-bg)] hover:bg-[var(--btn-export-hover)] text-white font-semibold px-4 py-2 text-sm rounded-md transition duration-300 btn-inverted-text">Export Results to CSV</button>
                    </div>
                </div>
                <div id="raw-wrapper">
                    <pre class="whitespace-pre-wrap break-all text-sm bg-[var(--bg-code)] text-[var(--text-primary)] p-4 rounded-lg"><code></code></pre>
                </div>
            </div>
        </div>

        <footer class="text-center text-[var(--text-secondary)] text-sm mt-8 border-t border-[var(--border-primary)] pt-6">
            <div class="mb-4 flex justify-center items-center gap-2">
                <button data-theme="light" class="theme-btn p-2 rounded-lg">Light</button>
                <button data-theme="dark" class="theme-btn p-2 rounded-lg">Dark</button>
                <button data-theme="retro" class="theme-btn p-2 rounded-lg">Retro</button>
                <button data-theme="high-contrast" class="theme-btn p-2 rounded-lg">High Contrast</button>
            </div>
            <p>&copy; Jonathan Berthold 2025</p>
            <div class="mt-2 space-x-4">
                <a href="https://moz.com/api/dashboard" target="_blank" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">API Dashboard</a>
                <span class="text-[var(--text-secondary)]">|</span>
                <a href="https://moz.com/products/api/keys" target="_blank" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">Get Moz API Key</a>
                <span class="text-[var(--text-secondary)]">|</span>
                 <a href="https://moz.com/api/docs/welcome" target="_blank" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">API Docs</a>
                <span class="text-[var(--text-secondary)]">|</span>
                <button id="readme-btn" class="hover:text-[var(--text-accent-hover)] transition text-[var(--text-accent)]">Read Me</button>
            </div>
        </footer>

    </div>

    <!-- Read Me Modal -->
    <div id="readme-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--bg-container)] border border-[var(--border-primary)] w-full max-w-3xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-primary)]">
                <h2 class="text-lg font-semibold text-[var(--text-primary)]">Read Me / Help</h2>
                <button id="close-readme-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button>
            </div>
            <div id="readme-modal-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentResultsData = null;
            let currentOriginalParams = null;
            let currentMethod = null;

            const allDOMElements = {
                apiKeyDisplay: document.getElementById('apiKeyDisplay'), 
                apiKeyText: document.getElementById('apiKeyText'), 
                editApiKeyBtn: document.getElementById('editApiKeyBtn'), 
                apiKeyInputArea: document.getElementById('apiKeyInputArea'), 
                apiKeyInput: document.getElementById('apiKeyInput'), 
                saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
                readmeBtn: document.getElementById('readme-btn'), 
                readmeModal: document.getElementById('readme-modal'), 
                closeReadmeBtn: document.getElementById('close-readme-btn'), 
                themeBtns: document.querySelectorAll('.theme-btn'), 
                methodSelector: document.getElementById('methodSelector'), 
                form: document.getElementById('api-form'), 
                submitBtn: document.getElementById('submit-btn'),
                errorMessage: document.getElementById('error-message'), 
                resultsContainer: document.getElementById('results-container'), 
                rawCode: document.querySelector('#raw-wrapper code'), 
                exportBtn: document.getElementById('export-btn'), 
                copyJsonBtn: document.getElementById('copy-json-btn'), 
                mozLogo: document.getElementById('moz-logo'),
                quotaDisplay: document.getElementById('quota-display'), 
                quotaText: document.getElementById('quota-text')
            };

            const populateInputs = () => {
                const createLabel = (text) => `<label class="block text-sm font-medium text-[var(--text-secondary)]">${text}</label>`;
                const createSelect = (id, options) => `<select id="${id}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">${options}</select>`;
                const createTextarea = (id, placeholder) => `<textarea id="${id}" rows="4" class="w-full bg-[var(--bg-input)] border border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)] placeholder-[var(--text-secondary)]" placeholder="${placeholder}"></textarea>`;
                const createDescription = text => `<p class="text-sm text-[var(--text-secondary)]">${text}</p>`;
                const createNumberInput = (id, value, min, max) => `<input type="number" id="${id}" value="${value}" min="${min}" max="${max}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">`;
                const createDateInput = (id) => `<input type="date" id="${id}" class="w-full bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">`;
                const createMultiSelect = (id, options) => `<select id="${id}" multiple class="w-full h-32 bg-[var(--bg-input-secondary)] border-[var(--border-secondary)] rounded-md p-2 mt-1 text-[var(--text-primary)]">${options}</select>`;
                
                const scopeOptions = `<option value="domain" selected>Domain</option><option value="subdomain">Subdomain</option><option value="subfolder">Subfolder</option><option value="url">URL</option>`;
                const limitedScopeOptions = `<option value="domain" selected>Domain</option><option value="subdomain">Subdomain</option><option value="url">URL</option>`;
                const localeOptions = `<option value="en-US" selected>en-US</option><option value="en-CA">en-CA</option><option value="en-GB">en-GB</option><option value="en-AU">en-AU</option>`;
                const keywordMetricOptions = `<option value="all" selected>All Metrics</option><option value="volume">Search Volume</option><option value="difficulty">Difficulty</option><option value="opportunity">Organic CTR</option><option value="priority">Priority</option>`;
                const topPagesFilterOptions = `<option value="all" selected>All</option><option value="status_200">Status 200</option><option value="status_301">Status 301</option><option value="status_302">Status 302</option><option value="status_4xx">Status 4xx</option><option value="status_5xx">Status 5xx</option>`;
                const topPagesSortOptions = `<option value="page_authority" selected>Page Authority</option><option value="root_domains_to_page">Linking Root Domains</option><option value="external_pages_to_page">External Linking Pages</option>`;
                const listLinksFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option><option value="not_deleted">not_deleted</option><option value="redirect">redirect</option><option value="not_redirect">not_redirect</option><option value="rel_canonical">rel_canonical</option><option value="not_rel_canonical">not_rel_canonical</option><option value="via_redirect">via_redirect</option><option value="not_via_redirect">not_via_redirect</option><option value="via_rel_canonical">via_rel_canonical</option><option value="not_via_rel_canonical">not_via_rel_canonical</option>`;
                const linkIntersectSortOptions = `<option value="matching_target_count" selected>Matching Target Count</option><option value="source_spam_score">Source Spam Score</option><option value="source_domain_authority">Source Domain Authority</option>`;
                const linkingDomainsSortOptions = `<option value="source_domain_authority" selected>Source Domain Authority</option><option value="source_link_propensity">Source Link Propensity</option><option value="source_spam_score">Source Spam Score</option>`;
                const linkingDomainsFilterOptions = `<option value="external">external</option><option value="follow">follow</option><option value="nofollow">nofollow</option><option value="deleted">deleted</option><option value="gained_last_60_days">gained_last_60_days</option><option value="lost_last_60_days">lost_last_60_days</option>`;
                const listLinksSortOptions = `<option value="source_page_authority" selected>Source Page Authority</option><option value="source_domain_authority">Source Domain Authority</option><option value="source_link_propensity">Source Link Propensity</option><option value="source_spam_score">Source Spam Score</option>`;

                document.getElementById('siteMetricsInputs').innerHTML = createDescription('Get metrics like DA, PA, Spam Score, and link counts for URLs.') + createLabel('Scope') + createSelect('smScopeSelect', scopeOptions) + createLabel('Domains / URLs') + createTextarea('smUrlsInput', 'One per line or comma-separated (must include http/https)');
                document.getElementById('keywordMetricsInputs').innerHTML = createDescription('Get volume, difficulty, CTR, and priority for keywords.') + createLabel('Metric Type') + createSelect('kmMetricTypeSelect', keywordMetricOptions) + createLabel('Locale') + createSelect('kmLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('kmKeywordsInput', 'One per line or comma-separated');
                document.getElementById('brandAuthorityInputs').innerHTML = createDescription('Get the Brand Authority™ score for a given site.') + createLabel('Domains / URLs') + createTextarea('baUrlsInput', 'One per line or comma-separated.');
                document.getElementById('searchIntentInputs').innerHTML = createDescription('Retrieve search intent scores for any keyword.') + createLabel('Locale') + createSelect('siLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('siKeywordsInput', 'One per line or comma-separated.');
                document.getElementById('rankingKeywordsInputs').innerHTML = createDescription('List keywords for which a site ranks.') + createLabel('Scope') + createSelect('rkScopeSelect', scopeOptions) + createLabel('Locale') + createSelect('rkLocaleSelect', localeOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 500)') + createNumberInput('rkLimit', 25, 1, 500) + createLabel('Domains / URLs') + createTextarea('rkUrlsInput', 'One per line or comma-separated.');
                document.getElementById('relatedKeywordsInputs').innerHTML = createDescription('Get a list of related keyword suggestions.') + createLabel('Locale') + createSelect('rlLocaleSelect', localeOptions) + createLabel('Keywords') + createTextarea('rlKeywordsInput', 'One per line or comma-separated.');
                document.getElementById('keywordCountInputs').innerHTML = createDescription('Count keywords for which a site ranks in the top 50.') + createLabel('Scope') + createSelect('kcScopeSelect', limitedScopeOptions) + createLabel('Locale') + createSelect('kcLocaleSelect', localeOptions) + createLabel('Domains / URLs') + createTextarea('kcUrlsInput', 'One per line or comma-separated.');
                document.getElementById('anchorTextInputs').innerHTML = createDescription('Get data about anchor text used to link to a specified site.') + createLabel('Scope') + createSelect('atScopeSelect', scopeOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('atLimit', 25, 1, 50) + createLabel('Domains / URLs') + createTextarea('atUrlsInput', 'One per line or comma-separated.');
                document.getElementById('recentlyGainedLinksInputs').innerHTML = createDescription('Get external root domains that added new links to a target during the past 60 days.') + createLabel('Scope') + createSelect('rglScopeSelect', scopeOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('rglLimit', 25, 1, 50) + createLabel('Begin Date (Optional)') + createDateInput('rglBeginDate') + createLabel('End Date (Optional)') + createDateInput('rglEndDate') + createLabel('Domains / URLs') + createTextarea('rglUrlsInput', 'One per line or comma-separated.');
                document.getElementById('recentlyLostLinksInputs').innerHTML = createDescription('Get root domains that removed links to a target during the past 60 days.') + createLabel('Scope') + createSelect('rllScopeSelect', scopeOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('rllLimit', 25, 1, 50) + createLabel('Begin Date (Optional)') + createDateInput('rllBeginDate') + createLabel('End Date (Optional)') + createDateInput('rllEndDate') + createLabel('Domains / URLs') + createTextarea('rllUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkingDomainsInputs').innerHTML = createDescription('Get a list of linking root domains to a target.') + createLabel('Scope') + createSelect('ldScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('ldSortSelect', linkingDomainsSortOptions) + createLabel('Filters (Ctrl+Click to select multiple)') + createMultiSelect('ldFilterSelect', linkingDomainsFilterOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('ldLimit', 25, 1, 50) + createLabel('Domains / URLs') + createTextarea('ldUrlsInput', 'One per line or comma-separated.');
                document.getElementById('finalRedirectInputs').innerHTML = createDescription('See the final redirect target of a page.') + createLabel('Scope') + createSelect('frScopeSelect', scopeOptions) + createLabel('Domains / URLs') + createTextarea('frUrlsInput', 'One per line or comma-separated.');
                document.getElementById('topPagesInputs').innerHTML = createDescription('Return a list of the top pages on a target domain.') + createLabel('Scope') + createSelect('tpScopeSelect', scopeOptions) + createLabel('Filter') + createSelect('tpFilterSelect', topPagesFilterOptions) + createLabel('Sort') + createSelect('tpSortSelect', topPagesSortOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('tpLimit', 25, 1, 50) + createLabel('Domains / URLs') + createTextarea('tpUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkIntersectInputs').innerHTML = createDescription('Find sites that link to some domains but not others.') + createLabel('Scope') + createSelect('liScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('liSortSelect', linkIntersectSortOptions) + createLabel('Minimum Matching Targets') + createNumberInput('liMinMatch', 1, 1, 6) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('liLimit', 25, 1, 50) + createLabel('Linking To') + createTextarea('liIsLinkingTo', 'One per line...') + createLabel('NOT Linking To (Optional)') + createTextarea('liNotLinkingTo', 'One per line...');
                document.getElementById('listLinksInputs').innerHTML = createDescription('Get a list of links to a target.') + createLabel('Scope') + createSelect('llScopeSelect', scopeOptions) + createLabel('Sort') + createSelect('llSortSelect', listLinksSortOptions) + createLabel('Filters (Ctrl+Click to select multiple)') + createMultiSelect('llFilterSelect', listLinksFilterOptions) + createLabel('Number of Results (Default 25; Choose from 1 to 50)') + createNumberInput('llLimit', 25, 1, 50) + createLabel('Domains / URLs') + createTextarea('llUrlsInput', 'One per line or comma-separated.');
                document.getElementById('linkStatusInputs').innerHTML = createDescription('Get the status of a link from a source to a target.') + createLabel('Target Scope') + createSelect('lsTargetScopeSelect', scopeOptions) + createLabel('Target URL') + createTextarea('lsTargetUrl', 'Target URL') + createLabel('Source Scope') + createSelect('lsSourceScopeSelect', scopeOptions) + createLabel('Source URL') + createTextarea('lsSourceUrl', 'Source URL');
            };
            
            const readmeContent = `<h2>Moz API Assistant - Help</h2><h3>Overview</h3><p>This tool allows you to connect directly to the Moz API (v3) using your personal API key to fetch valuable SEO data.</p><h2>Setup</h2><ol><li><strong>Get API Key:</strong> You need a valid Moz API Key. You can get one or manage your existing key from the <a href="https://moz.com/products/api/keys" target="_blank">Moz API Dashboard</a>.</li><li><strong>Add Key to Tool:</strong> Use the API Key input at the top of the tool. Your key is stored securely in your browser's local storage.</li></ol><h2>Features</h2><p>Select a method from the dropdown to get started:</p><hr class="border-slate-700 my-4"><div class="readme-method"><h3><strong><u>Fetch Site Metrics</u></strong></h3><ul><li><strong>Description:</strong> Get metrics like DA, PA, Spam Score, and link counts for URLs.</li></ul></div><div class="readme-method"><h3><strong><u>Fetch Brand Authority</u></strong></h3><ul><li><strong>Description:</strong> Get the Brand Authority™ score for a given site.</li></ul></div><div class="readme-method"><h3><strong><u>List Top Pages</u></strong></h3><ul><li><strong>Description:</strong> Return a list of the top pages on a target domain.</li></ul></div><div class="readme-method"><h3><strong><u>Fetch Keyword Metrics</u></strong></h3><ul><li><strong>Description:</strong> Get volume, difficulty, CTR, and priority for keywords.</li></ul></div><div class="readme-method"><h3><strong><u>Fetch Search Intent</u></strong></h3><ul><li><strong>Description:</strong> Retrieve search intent scores for any keyword.</li></ul></div><div class="readme-method"><h3><strong><u>List Ranking Keywords</u></strong></h3><ul><li><strong>Description:</strong> List keywords for which a site ranks.</li></ul></div><div class="readme-method"><h3><strong><u>List Related Keywords</u></strong></h3><ul><li><strong>Description:</strong> Get a list of related keyword suggestions.</li></ul></div><div class="readme-method"><h3><strong><u>Count Ranking Keywords</u></strong></h3><ul><li><strong>Description:</strong> Count keywords for which a site ranks in the top 50.</li></ul></div><div class="readme-method"><h3><strong><u>Get Anchor Texts Lists</u></strong></h3><ul><li><strong>Description:</strong> Get data about anchor text used to link to a specified site.</li></ul></div><div class="readme-method"><h3><strong><u>List Linking Domains</u></strong></h3><ul><li><strong>Description:</strong> Get a list of linking root domains to a target.</li></ul></div><div class="readme-method"><h3><strong><u>List Recently Gained Links</u></strong></h3><ul><li><strong>Description:</strong> Get external root domains that added new links to a target during the past 60 days.</li></ul></div><div class="readme-method"><h3><strong><u>List Recently Lost Links</u></strong></h3><ul><li><strong>Description:</strong> Get root domains that removed links to a target during the past 60 days.</li></ul></div><div class="readme-method"><h3><strong><u>Fetch Link Intersects</u></strong></h3><ul><li><strong>Description:</strong> Find sites that link to some domains but not others.</li></ul></div><div class="readme-method"><h3><strong><u>List Links</u></strong></h3><ul><li><strong>Description:</strong> Get a list of links to a target.</li></ul></div><div class="readme-method"><h3><strong><u>Get Final Redirect Target</u></strong></h3><ul><li><strong>Description:</strong> See the final redirect target of a page.</li></ul></div><div class="readme-method"><h3><strong><u>Get Link Status</u></strong></h3><ul><li><strong>Description:</strong> Get the status of a link from a source to a target.</li></ul></div><hr class="border-slate-700 my-4"><h2>General Notes</h2><ul><li><strong>API Usage:</strong> Each API call consumes rows from your Moz API subscription quota. Be mindful of limits.</li><li><strong>Errors:</strong> If an API call fails, an error message will be displayed and the JSON response will contain details.</li></ul>`;
            
            const setupEventListeners = () => {
                allDOMElements.readmeBtn.addEventListener('click', () => allDOMElements.readmeModal.classList.remove('hidden'));
                allDOMElements.closeReadmeBtn.addEventListener('click', () => allDOMElements.readmeModal.classList.add('hidden'));
                allDOMElements.readmeModal.addEventListener('click', (e) => {
                    if (e.target === allDOMElements.readmeModal) allDOMElements.readmeModal.classList.add('hidden');
                });
                allDOMElements.themeBtns.forEach(btn => {
                    btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
                });
                allDOMElements.saveApiKeyBtn.addEventListener('click', () => {
                    const key = allDOMElements.apiKeyInput.value.trim();
                    if (key) {
                        localStorage.setItem('mozApiKey', key);
                        loadApiKey();
                    }
                });
                allDOMElements.editApiKeyBtn.addEventListener('click', () => {
                    allDOMElements.apiKeyDisplay.classList.add('hidden');
                    allDOMElements.apiKeyInputArea.classList.remove('hidden');
                    allDOMElements.apiKeyInput.focus();
                });
                allDOMElements.methodSelector.addEventListener('change', () => {
                    document.querySelectorAll('.input-section').forEach(section => section.style.display = 'none');
                    const selectedMethod = allDOMElements.methodSelector.value;
                    if (selectedMethod) {
                        const sectionToShow = document.getElementById(selectedMethod + 'Inputs');
                        if (sectionToShow) sectionToShow.style.display = 'block';
                        allDOMElements.submitBtn.disabled = false;
                    } else {
                        allDOMElements.submitBtn.disabled = true;
                    }
                });
                allDOMElements.form.addEventListener('submit', handleFormSubmit);
                allDOMElements.copyJsonBtn.addEventListener('click', handleCopyJson);
                allDOMElements.exportBtn.addEventListener('click', handleExportCsv);
            };

            const applyTheme = (theme) => {
                document.documentElement.className = theme;
                localStorage.setItem('theme', theme);
                allDOMElements.themeBtns.forEach(btn => {
                    btn.classList.toggle('font-bold', btn.dataset.theme === theme);
                });
                allDOMElements.mozLogo.style.filter = 'none';
            };

            const fetchQuota = async (apiKey) => {
                if (!apiKey) return;
                try {
                    const response = await fetch('https://mozapi-proxy-server.vercel.app/api/getMozData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ apiKey, method: 'getQuota' })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to fetch quota');
                    const { used, allotted } = data.quota.quota; // Corrected nesting
                    allDOMElements.quotaText.textContent = `API Usage: ${used.toLocaleString()} / ${allotted.toLocaleString()} Rows Used`;
                    allDOMElements.quotaText.style.color = used >= allotted ? 'var(--text-error)' : 'var(--text-secondary)';
                    allDOMElements.quotaDisplay.classList.remove('hidden');
                } catch (error) {
                    console.error("Quota fetch error:", error);
                    allDOMElements.quotaText.textContent = 'Could not retrieve API usage.';
                    allDOMElements.quotaDisplay.classList.remove('hidden');
                }
            };
            
            const loadApiKey = () => {
                const savedKey = localStorage.getItem('mozApiKey');
                if (savedKey) {
                    allDOMElements.apiKeyText.textContent = `${savedKey.substring(0, 6)}...${savedKey.substring(savedKey.length - 4)}`;
                    allDOMElements.apiKeyInput.value = savedKey;
                    allDOMElements.apiKeyDisplay.classList.remove('hidden');
                    allDOMElements.apiKeyDisplay.classList.add('flex');
                    allDOMElements.apiKeyInputArea.classList.add('hidden');
                    fetchQuota(savedKey);
                } else {
                    allDOMElements.apiKeyDisplay.classList.add('hidden');
                    allDOMElements.apiKeyInputArea.classList.remove('hidden');
                    allDOMElements.quotaDisplay.classList.add('hidden');
                }
            };
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                allDOMElements.errorMessage.classList.add('hidden');
                allDOMElements.resultsContainer.classList.add('hidden');
                allDOMElements.submitBtn.disabled = true;
                allDOMElements.submitBtn.innerHTML = '<div class="spinner"></div><span class="ml-2">Processing...</span>';
                const apiKey = allDOMElements.apiKeyInput.value.trim();
                const selectedMethod = allDOMElements.methodSelector.value;
                if (!apiKey || !selectedMethod) {
                    displayError('Please provide an API Key and select a method.');
                    resetSubmitButton(); return;
                }
                let payload;
                try {
                    payload = buildPayload(apiKey, selectedMethod);
                } catch (error) {
                    displayError(error.message);
                    resetSubmitButton(); return;
                }
                const PROXY_URL = 'https://mozapi-proxy-server.vercel.app/api/getMozData';
                try {
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `Request failed with status ${response.status}`);
                    currentResultsData = data;
                    currentOriginalParams = payload.params;
                    currentMethod = selectedMethod;
                    showRawJsonResults(data);
                    fetchQuota(apiKey);
                } catch (error) {
                    displayError(error.message);
                } finally {
                    resetSubmitButton();
                }
            }

            function handleCopyJson() {
                if (allDOMElements.rawCode.textContent) {
                    navigator.clipboard.writeText(allDOMElements.rawCode.textContent).then(() => {
                        allDOMElements.copyJsonBtn.textContent = 'Copied!';
                        setTimeout(() => { allDOMElements.copyJsonBtn.textContent = 'Copy JSON'; }, 2000);
                    }, () => {
                        displayError('Failed to copy JSON.');
                    });
                }
            }
            
            function handleExportCsv() {
                 if (currentResultsData) {
                    exportDataToCsv(currentResultsData, currentMethod, currentOriginalParams);
                } else {
                    displayError("No data available to export.");
                }
            }
            
            function showRawJsonResults(data) {
                allDOMElements.rawCode.textContent = JSON.stringify(data, null, 2);
                allDOMElements.resultsContainer.classList.remove('hidden');
            }

            function displayError(message) {
                allDOMElements.errorMessage.textContent = message;
                allDOMElements.errorMessage.classList.remove('hidden');
            }
            
            function resetSubmitButton() {
                allDOMElements.submitBtn.disabled = allDOMElements.methodSelector.value === "";
                allDOMElements.submitBtn.innerHTML = 'Run Request';
            }

            function buildPayload(apiKey, selectedMethod) {
                let payload = { apiKey, method: selectedMethod, params: {} };
                const getInputValue = (id) => document.getElementById(id)?.value;
                const getCleanedList = (id) => getInputValue(id)?.split(/[\n,]/).map(item => item.trim()).filter(Boolean);
                const getSelectedOptions = (id) => Array.from(document.getElementById(id).selectedOptions).map(({ value }) => value);

                switch (selectedMethod) {
                    case 'siteMetrics': payload.params = { scope: getInputValue('smScopeSelect'), targets: getCleanedList('smUrlsInput') }; break;
                    case 'keywordMetrics': payload.params = { metricType: getInputValue('kmMetricTypeSelect'), locale: getInputValue('kmLocaleSelect'), keywords: getCleanedList('kmKeywordsInput') }; break;
                    case 'brandAuthority': payload.params = { targets: getCleanedList('baUrlsInput') }; break;
                    case 'searchIntent': payload.params = { locale: getInputValue('siLocaleSelect'), keywords: getCleanedList('siKeywordsInput') }; break;
                    case 'rankingKeywords': payload.params = { scope: getInputValue('rkScopeSelect'), locale: getInputValue('rkLocaleSelect'), targets: getCleanedList('rkUrlsInput'), limit: parseInt(getInputValue('rkLimit'), 10) || 25 }; break;
                    case 'relatedKeywords': payload.params = { locale: getInputValue('rlLocaleSelect'), keywords: getCleanedList('rlKeywordsInput') }; break;
                    case 'keywordCount': payload.params = { scope: getInputValue('kcScopeSelect'), locale: getInputValue('kcLocaleSelect'), targets: getCleanedList('kcUrlsInput') }; break;
                    case 'anchorText': payload.params = { scope: getInputValue('atScopeSelect'), targets: getCleanedList('atUrlsInput'), limit: parseInt(getInputValue('atLimit'), 10) || 25 }; break;
                    case 'recentlyGainedLinks': payload.params = { scope: getInputValue('rglScopeSelect'), targets: getCleanedList('rglUrlsInput'), limit: parseInt(getInputValue('rglLimit'), 10) || 25, beginDate: getInputValue('rglBeginDate'), endDate: getInputValue('rglEndDate') }; break;
                    case 'recentlyLostLinks': payload.params = { scope: getInputValue('rllScopeSelect'), targets: getCleanedList('rllUrlsInput'), limit: parseInt(getInputValue('rllLimit'), 10) || 25, beginDate: getInputValue('rllBeginDate'), endDate: getInputValue('rllEndDate') }; break;
                    case 'linkingDomains': payload.params = { scope: getInputValue('ldScopeSelect'), targets: getCleanedList('ldUrlsInput'), limit: parseInt(getInputValue('ldLimit'), 10) || 25, sort: getInputValue('ldSortSelect'), filters: getSelectedOptions('ldFilterSelect')}; break;
                    case 'finalRedirect': payload.params = { scope: getInputValue('frScopeSelect'), targets: getCleanedList('frUrlsInput') }; break;
                    case 'topPages': payload.params = { scope: getInputValue('tpScopeSelect'), targets: getCleanedList('tpUrlsInput'), limit: parseInt(getInputValue('tpLimit'), 10) || 25, filter: getInputValue('tpFilterSelect'), sort: getInputValue('tpSortSelect') }; break;
                    case 'linkIntersect': {
                        const intersectScope = getInputValue('liScopeSelect');
                        payload.params = { 
                            scope: intersectScope, 
                            limit: parseInt(getInputValue('liLimit'), 10) || 25, 
                            is_linking_to: getCleanedList('liIsLinkingTo').map(q => ({query: q, scope: intersectScope})), 
                            not_linking_to: getCleanedList('liNotLinkingTo').map(q => ({query: q, scope: intersectScope})), 
                            sort: getInputValue('liSortSelect'), 
                            minimum_matching_targets: parseInt(getInputValue('liMinMatch'), 10) || 1 
                        }; 
                        break;
                    }
                    case 'listLinks': payload.params = { scope: getInputValue('llScopeSelect'), targets: getCleanedList('llUrlsInput'), limit: parseInt(getInputValue('llLimit'), 10) || 25, filters: getSelectedOptions('llFilterSelect'), sort: getInputValue('llSortSelect') }; break;
                    case 'linkStatus': payload.params = { targetScope: getInputValue('lsTargetScopeSelect'), targetQuery: getInputValue('lsTargetUrl'), sourceScope: getInputValue('lsSourceScopeSelect'), sourceQuery: getInputValue('lsSourceUrl') }; break;
                    default: throw new Error('Invalid method selected.');
                }
                if (['siteMetrics', 'keywordMetrics', 'brandAuthority', 'searchIntent', 'rankingKeywords', 'relatedKeywords', 'keywordCount', 'anchorText', 'recentlyGainedLinks', 'recentlyLostLinks', 'linkingDomains', 'finalRedirect', 'topPages', 'listLinks'].includes(selectedMethod)) {
                    if ((payload.params.targets?.length === 0) && (payload.params.keywords?.length === 0)) {
                        throw new Error('Please enter at least one URL or Keyword.');
                    }
                }
                 if (selectedMethod === 'linkIntersect' && payload.params.is_linking_to.length === 0) {
                     throw new Error('Please enter at least one URL for "Linking To".');
                 }
                 if (selectedMethod === 'linkStatus' && (!payload.params.targetQuery || !payload.params.sourceQuery)) {
                    throw new Error('Please enter both a Target and Source URL for Link Status.');
                 }
                return payload;
            }
             
            function exportDataToCsv(results, method, originalParams) {
                let rows = [];
                const na = 'N/A';
                const snakeToTitleCase = (s) => s.replace(/^_*(.)|_+(.)/g, (s, c, d) => c ? c.toUpperCase() : ' ' + d.toUpperCase());
                const processLinkMetrics = (linkItem, query) => {
                    const baseInfo = { 'Query': query, 'Scope': originalParams.scope };
                    const metrics = linkItem.site_metrics || {};
                    const otherData = { ...linkItem };
                    delete otherData.site_metrics;
                    const combined = { ...baseInfo, ...metrics, ...otherData };
                    const titleCased = {};
                    for (const key in combined) {
                        titleCased[snakeToTitleCase(key)] = combined[key];
                    }
                    return titleCased;
                };

                results.forEach((res, i) => {
                    let query;
                    if (method === 'linkIntersect') {
                        query = 'N/A';
                    } else if (method === 'linkStatus') {
                        query = originalParams.sourceQuery;
                    }
                    else {
                        query = (originalParams.targets || originalParams.keywords)[i] || na;
                    }
                    
                    if (res.status !== 'success') {
                        rows.push({ Query: query, Status: `Error: ${res.reason || 'Unknown'}` });
                        return;
                    }
                    switch (method) {
                        case 'brandAuthority':
                            rows.push({'Site Query': res.data.site_query?.query || na, 'Scope': res.data.site_query?.scope || na, 'Brand Authority Score': res.data.site_metrics?.brand_authority_score ?? na, 'Original Query': res.data.site_query?.original_site_query?.query || query });
                            break;
                        case 'siteMetrics': {
                            const metrics = res.data.site_metrics || {};
                            const orderedMetrics = {'Page Authority': metrics.page_authority, 'Domain Authority': metrics.domain_authority, 'Spam Score': metrics.spam_score };
                            for(const key in metrics){
                                if(!['page_authority', 'domain_authority', 'spam_score'].includes(key)) {
                                    orderedMetrics[snakeToTitleCase(key)] = metrics[key];
                                }
                            }
                             rows.push({'Query': res.data.site_query?.query || query, 'Scope': res.data.site_query?.scope || na, 'Original Query': res.data.site_query?.original_site_query?.query || query, ...orderedMetrics });
                            break;
                        }
                        case 'keywordMetrics': {
                            const metricTypeMap = { 'all': 'All Keyword Metrics', 'volume': 'Search Volume', 'difficulty': 'Difficulty', 'opportunity': 'Organic CTR', 'priority': 'Priority' };
                            rows.push({'Keyword': res.data.serp_query?.keyword || query, 'API Call': metricTypeMap[originalParams.metricType] || originalParams.metricType, 'Locale': res.data.serp_query?.locale || na, 'Device': res.data.serp_query?.device || na, 'Engine': res.data.serp_query?.engine || na, 'Volume': res.data.keyword_metrics?.volume ?? na, 'Difficulty': res.data.keyword_metrics?.difficulty ?? na, 'Opportunity CTR': res.data.keyword_metrics?.organic_ctr ?? na, 'Priority': res.data.keyword_metrics?.priority ?? na });
                            break;
                        }
                        case 'searchIntent': {
                             const intentData = {};
                             (res.data.keyword_intent?.all_intents || []).forEach(intent => {
                                intentData[`${snakeToTitleCase(intent.label)} Score`] = intent.score ?? na;
                             });
                             rows.push({'Keyword': res.data.serp_query?.keyword || query, 'Locale': res.data.serp_query?.locale || na, 'Device': res.data.serp_query?.device || na, 'Engine': res.data.serp_query?.engine || na, 'Primary Intent': (res.data.keyword_intent?.primary_intents || []).join(', ') || na, ...intentData });
                             break;
                        }
                        case 'rankingKeywords': {
                            const baseInfo = { 'Query': query, 'Scope': originalParams.scope, 'Locale': originalParams.locale };
                            if(res.data.ranking_keywords?.length > 0){
                                res.data.ranking_keywords.forEach(kw => { rows.push({ ...baseInfo, 'Keyword': kw.keyword, 'Ranking Page': kw.ranking_page, 'Rank Position': kw.rank_position, 'Difficulty': kw.difficulty, 'Volume': kw.volume }); });
                            } else { rows.push({ ...baseInfo, Status: 'No ranking keywords found' }); }
                            break;
                        }
                        case 'relatedKeywords': {
                             const baseInfo = { 'Keyword': query, 'Locale': res.data.serp_query?.locale, 'Device': res.data.serp_query?.device, 'Engine': res.data.serp_query?.engine };
                             if(res.data.suggestions?.length > 0){
                                res.data.suggestions.forEach(sug => { rows.push({ ...baseInfo, 'Suggested Keyword': sug.keyword, 'Relevance': sug.relevance }); });
                             } else { rows.push({ ...baseInfo, Status: 'No suggestions found' }); }
                             break;
                        }
                        case 'keywordCount': {
                            const positions = res.data.ranking_keyword_count?.position || {};
                            const rankCounts = {};
                            for (let i = 1; i <= 50; i++) {
                                rankCounts[`Rank ${i} Count`] = positions[`rank_${i}`] ?? 0;
                            }
                            rows.push({'Query': query, 'Scope': originalParams.scope, 'Locale': originalParams.locale, 'Total Ranking Count': res.data.ranking_keyword_count?.total ?? na, ...rankCounts });
                            break;
                        }
                        case 'anchorText': {
                            const baseInfo = { 'Query': query, 'Scope': originalParams.scope };
                            if(res.data.anchor_texts?.length > 0){
                                res.data.anchor_texts.forEach(at => { rows.push({ ...baseInfo, 'Anchor Text': at.text, 'External Root Domains': at.external_root_domains, 'External Pages': at.external_pages }); });
                            } else { rows.push({ ...baseInfo, Status: 'No anchor texts found' }); }
                            break;
                        }
                        case 'recentlyGainedLinks':
                            (res.data.gained_linking_domains || []).forEach(link => rows.push(processLinkMetrics(link, query)));
                            if (!res.data.gained_linking_domains || res.data.gained_linking_domains.length === 0) rows.push({ Query: query, Status: 'No recently gained links found' });
                            break;
                        case 'recentlyLostLinks':
                            (res.data.lost_linking_domains || []).forEach(link => rows.push(processLinkMetrics(link, query)));
                             if (!res.data.lost_linking_domains || res.data.lost_linking_domains.length === 0) rows.push({ Query: query, Status: 'No recently lost links found' });
                            break;
                        case 'linkingDomains':
                            (res.data.linking_domains || []).forEach(link => rows.push(processLinkMetrics(link, query)));
                            if (!res.data.linking_domains || res.data.linking_domains.length === 0) rows.push({ Query: query, Status: 'No linking domains found' });
                            break;
                        case 'topPages':
                             (res.data.top_pages || []).forEach(page => {
                                const pageData = { 'Query': query, 'Scope': originalParams.scope, ...page };
                                const titleCased = {};
                                for(const key in pageData) { titleCased[snakeToTitleCase(key)] = pageData[key]; }
                                rows.push(titleCased);
                             });
                             if (!res.data.top_pages || res.data.top_pages.length === 0) rows.push({ Query: query, Status: 'No top pages found' });
                            break;
                        case 'finalRedirect':
                            rows.push({ 'Query': query, 'Scope': originalParams.scope, 'Original Query': res.data.site_query?.original_site_query?.query || query, 'Destination': res.data.destination || 'No redirect found' });
                            break;
                        case 'linkIntersect':
                            (res.data.link_intersects || []).forEach(link => rows.push({ 'Page': link.page, 'Title': link.title, 'Domain Authority': link.domain_authority, 'Spam Score': link.spam_score, 'Matching Target Indexes': (link.matching_target_indexes || []).join(', ') }));
                            if(!res.data.link_intersects || res.data.link_intersects.length === 0) rows.push({ Status: 'No intersecting links found' });
                            break;
                        case 'listLinks':
                            (res.data.links || []).forEach(link => {
                                const sourceMetrics = link.source_site_metrics || {};
                                const targetMetrics = link.target_site_metrics || {};
                                const linkInfo = { ...link };
                                delete linkInfo.source_site_metrics;
                                delete linkInfo.target_site_metrics;

                                const row = {};
                                for (const key in sourceMetrics) row[`Source ${snakeToTitleCase(key)}`] = sourceMetrics[key];
                                for (const key in targetMetrics) row[`Target ${snakeToTitleCase(key)}`] = targetMetrics[key];
                                for (const key in linkInfo) row[snakeToTitleCase(key)] = linkInfo[key];
                                rows.push(row);
                            });
                             if (!res.data.links || res.data.links.length === 0) rows.push({ Query: query, Status: 'No links found' });
                            break;
                        case 'linkStatus':
                            rows.push({ 'Target Query': res.data.target_site_query?.query, 'Source Query': res.data.source_site_query?.query, 'Exists': res.data.exists });
                            break;
                    }
                });
                if (rows.length === 0) { displayError("No valid data to export."); return; }
                const allKeys = [...new Set(rows.flatMap(row => Object.keys(row)))];
                const header = allKeys.join(',');
                const csvRows = rows.map(row => allKeys.map(key => {
                    const value = row[key] === undefined || row[key] === null ? '' : row[key];
                    const stringValue = String(value);
                    if (stringValue.includes(',') || stringValue.includes('"')) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    return stringValue;
                }).join(','));
                const csvString = [header, ...csvRows].join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `moz-api-results-${method}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Initial calls
            populateInputs();
            setupEventListeners();
            loadApiKey();
            allDOMElements.submitBtn.disabled = true;

        });
    </script>
</body>
</html>

